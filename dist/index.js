(()=>{"use strict";var e={208:(e,t,n)=>{n.d(t,{A:()=>s});var a=n(601),i=n.n(a),l=n(314),o=n.n(l)()(i());o.push([e.id,"/* 基础高亮样式 */\n.atable-highlight {\n    background-color: rgba(255, 215, 0, 0.4); /* 金色背景，带透明度 */\n    padding: 1px 4px;\n    border-radius: 5px;\n    cursor: pointer;\n    transition: background-color 0.2s ease;\n    font-weight: bold;\n}\n\n.atable-highlight:hover {\n    background-color: rgba(255, 215, 0, 0.6); /* 鼠标悬停时加深背景色 */\n}\n\n/* 模板列表项样式 */\n.atable-template-content {\n    max-height: 150px; /* 设置一个最大高度 */\n    overflow-y: auto;  /* 当内容超出时，显示垂直滚动条 */\n    resize: vertical;  /* 允许用户垂直调整大小 */\n}\n\n.atable-template-item {\n    margin-bottom: 8px;\n    align-items: stretch;\n    border: 1px solid var(--border-color, #cccccc);\n    border-radius: 5px;\n    padding: 8px;\n    transition: border-color 0.2s, background-color 0.2s;\n    cursor: pointer;\n}\n\n.atable-template-inputs {\n    flex: 1;\n    display: flex;\n    flex-direction: column;\n    margin-right: 8px;\n}\n\n.atable-template-name {\n    margin-bottom: 5px;\n    font-weight: bold;\n}\n\n.atable-delete-template {\n    align-self: center;\n}\n\n/* 模板选中时的高亮样式 */\n.atable-template-item-selected {\n    border-color: var(--link-color, #4a90e2);\n    background-color: rgba(var(--link-color-rgb, 74, 144, 226), 0.1);\n}\n\n/* 用于禁用UI区域的样式 */\n.disabled-section {\n    opacity: 0.6;\n    pointer-events: none;\n}\n\n/* Tag container styles */\n.tag-container {\n    display: flex;\n    flex-wrap: wrap;\n    gap: 5px;\n    margin-top: 5px;\n    margin-bottom: 10px;\n}\n\n.tag-item {\n    background-color: var(--background-color-secondary);\n    border: 1px solid var(--border-color);\n    border-radius: 5px;\n    padding: 5px 10px;\n    display: flex;\n    align-items: center;\n    gap: 8px;\n}\n\n.tag-item .delete-tag {\n    cursor: pointer;\n    font-weight: bold;\n    color: var(--text-color-secondary);\n}\n\n.tag-item .delete-tag:hover {\n    color: var(--text-color);\n}\n\n.add-tag-container {\n    display: flex;\n    gap: 10px;\n    align-items: center;\n}\n\n.add-tag-container .text_pole {\n    flex-grow: 1;\n}\n",""]);const s=o},314:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var n="",a=void 0!==t[5];return t[4]&&(n+="@supports (".concat(t[4],") {")),t[2]&&(n+="@media ".concat(t[2]," {")),a&&(n+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),n+=e(t),a&&(n+="}"),t[2]&&(n+="}"),t[4]&&(n+="}"),n})).join("")},t.i=function(e,n,a,i,l){"string"==typeof e&&(e=[[null,e,void 0]]);var o={};if(a)for(var s=0;s<this.length;s++){var r=this[s][0];null!=r&&(o[r]=!0)}for(var c=0;c<e.length;c++){var d=[].concat(e[c]);a&&o[d[0]]||(void 0!==l&&(void 0===d[5]||(d[1]="@layer".concat(d[5].length>0?" ".concat(d[5]):""," {").concat(d[1],"}")),d[5]=l),n&&(d[2]?(d[1]="@media ".concat(d[2]," {").concat(d[1],"}"),d[2]=n):d[2]=n),i&&(d[4]?(d[1]="@supports (".concat(d[4],") {").concat(d[1],"}"),d[4]=i):d[4]="".concat(i)),t.push(d))}},t}},601:e=>{e.exports=function(e){return e[1]}},72:e=>{var t=[];function n(e){for(var n=-1,a=0;a<t.length;a++)if(t[a].identifier===e){n=a;break}return n}function a(e,a){for(var l={},o=[],s=0;s<e.length;s++){var r=e[s],c=a.base?r[0]+a.base:r[0],d=l[c]||0,p="".concat(c," ").concat(d);l[c]=d+1;var m=n(p),u={css:r[1],media:r[2],sourceMap:r[3],supports:r[4],layer:r[5]};if(-1!==m)t[m].references++,t[m].updater(u);else{var g=i(u,a);a.byIndex=s,t.splice(s,0,{identifier:p,updater:g,references:1})}o.push(p)}return o}function i(e,t){var n=t.domAPI(t);n.update(e);return function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;n.update(e=t)}else n.remove()}}e.exports=function(e,i){var l=a(e=e||[],i=i||{});return function(e){e=e||[];for(var o=0;o<l.length;o++){var s=n(l[o]);t[s].references--}for(var r=a(e,i),c=0;c<l.length;c++){var d=n(l[c]);0===t[d].references&&(t[d].updater(),t.splice(d,1))}l=r}}},659:e=>{var t={};e.exports=function(e,n){var a=function(e){if(void 0===t[e]){var n=document.querySelector(e);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(e){n=null}t[e]=n}return t[e]}(e);if(!a)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");a.appendChild(n)}},540:e=>{e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},56:(e,t,n)=>{e.exports=function(e){var t=n.nc;t&&e.setAttribute("nonce",t)}},825:e=>{e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=e.insertStyleElement(e);return{update:function(n){!function(e,t,n){var a="";n.supports&&(a+="@supports (".concat(n.supports,") {")),n.media&&(a+="@media ".concat(n.media," {"));var i=void 0!==n.layer;i&&(a+="@layer".concat(n.layer.length>0?" ".concat(n.layer):""," {")),a+=n.css,i&&(a+="}"),n.media&&(a+="}"),n.supports&&(a+="}");var l=n.sourceMap;l&&"undefined"!=typeof btoa&&(a+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(l))))," */")),t.styleTagTransform(a,e,t.options)}(t,e,n)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}},113:e=>{e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}}},t={};function n(a){var i=t[a];if(void 0!==i)return i.exports;var l=t[a]={id:a,exports:{}};return e[a](l,l.exports,n),l.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var a in t)n.o(t,a)&&!n.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.nc=void 0;var a=n(72),i=n.n(a),l=n(825),o=n.n(l),s=n(659),r=n.n(s),c=n(56),d=n.n(c),p=n(540),m=n.n(p),u=n(113),g=n.n(u),b=n(208),h={};h.styleTagTransform=g(),h.setAttributes=d(),h.insert=r().bind(null,"head"),h.domAPI=o(),h.insertStyleElement=m();i()(b.A,h);b.A&&b.A.locals&&b.A.locals;let f,_,v;function y(e,...t){const n=(new Date).toLocaleTimeString(),a=t.map((e=>{if("object"==typeof e&&null!==e)try{return JSON.stringify(e)}catch(e){return"Unserializable Object"}return e})).join(" "),i=`[${n}] [${e.toUpperCase()}]: ${a}\n`;"function"==typeof console[e]?console[e](...t):console.log(...t),f&&(f.value+=i,f.scrollTop=f.scrollHeight)}async function x(){if(f&&navigator.clipboard)try{await navigator.clipboard.writeText(f.value);const e=_.querySelector("span").textContent;_.querySelector("span").textContent="已复制!",setTimeout((()=>{_.querySelector("span").textContent=e}),2e3)}catch(e){T.error("无法复制日志:",e)}}function I(){f&&(f.value="")}const T={init:function(){f=document.getElementById("atable-log-textarea"),_=document.getElementById("atable-copy-log"),v=document.getElementById("atable-clear-log"),_&&_.addEventListener("click",x),v&&v.addEventListener("click",I)},log:(...e)=>y("log",...e),info:(...e)=>y("info",...e),warn:(...e)=>y("warn",...e),error:(...e)=>y("error",...e)},w=T,{extensionSettings:S,saveSettingsDebounced:k}=globalThis.SillyTavern.getContext(),A="feinianyu-atable",C=Object.freeze({enabled:!0,nonHighlightedWords:"你,我,他,她",openingTagPatterns:["at-tag"],closingTagPatterns:["/at-tag"],autoInject:!0,enableTemplateReplacement:!0,activeTemplateIndex:0,templates:[{name:"默认模板",content:"(我对{{name}}说){{content}}"}],activePromptTemplateIndex:0,promptTemplates:[{name:"默认提示词",content:"默认提示词"}],activeHighlightStyleIndex:0,highlightStyles:[{name:"金黄色",css:".atable-highlight {\n    background-color: rgba(255, 215, 0, 0.4);\n    padding: 1px 4px;\n    border-radius: 5px;\n    cursor: pointer;\n    transition: background-color 0.2s ease;\n    font-weight: bold;\n    box-shadow: 0 0 5px rgba(255, 215, 0, 0.7);\n}"},{name:"Brand Blue",css:".atable-highlight {\n    color: #4a90e2;\n    background-color: rgba(74, 144, 226, 0.1);\n    padding: 1px 4px;\n    border-radius: 5px;\n    cursor: pointer;\n    font-weight: bold;\n}"},{name:"Neon Cyan",css:".atable-highlight {\n    color: #00ffff;\n    background-color: rgba(0, 255, 255, 0.1);\n    padding: 1px 4px;\n    border-radius: 3px;\n    border: 1px solid rgba(0, 255, 255, 0.3);\n    cursor: pointer;\n    text-shadow: 0 0 3px #00ffff;\n}"},{name:"下划线",css:".atable-highlight {\n    text-decoration: underline;\n    text-decoration-color: #4a90e2;\n    text-decoration-thickness: 2px;\n    cursor: pointer;\n    font-weight: bold;\n    background-color: transparent;\n}"}]});const E=function(){S[A]||(w.log("Initializing default settings for the first time."),S[A]=structuredClone(C));const e=S[A];e.sendFormat&&!e.templates&&(w.log("Migrating old settings for send templates..."),e.templates=[{name:"Imported Template",content:e.sendFormat}],e.activeTemplateIndex=0,delete e.sendFormat,k());for(const t of Object.keys(C))Object.hasOwn(e,t)||(e[t]=C[t]);return e}();let P=[];const{saveSettingsDebounced:j}=globalThis.SillyTavern.getContext();function H(e,t){e.empty(),t.forEach(((t,n)=>{const a=`\n            <div class="tag-item">\n                <span>${t}</span>\n                ${0===n?"":`<span class="delete-tag" data-index="${n}" title="Delete pattern">✖</span>`}\n            </div>\n        `;e.append(a)}))}function O(e,t,n,a){const i=$(e),l=$(t),o=$(n),s=()=>{const e=i.val().trim();e&&!a.includes(e)&&(a.push(e),j(),H(o,a),i.val(""))};l.on("click",s),i.on("keypress",(function(e){13===e.which&&s()})),o.on("click",".delete-tag",(function(){const e=parseInt($(this).data("index"),10);0!==e&&(a.splice(e,1),j(),H(o,a))}))}function M(){const e=E.highlightStyles[E.activeHighlightStyleIndex];e&&e.css?$("#feinianyu_atable_dynamic_styles").text(e.css):$("#feinianyu_atable_dynamic_styles").text("")}function N(){const e=$("#feinianyu_atable_highlight_style_list_container");e.empty(),E.highlightStyles.forEach(((t,n)=>{const a=`\n            <div class="atable-template-item flex-container ${n===E.activeHighlightStyleIndex?"atable-template-item-selected":""}" data-index="${n}">\n                <div class="atable-template-inputs">\n                    <input type="text" class="text_pole atable-style-name" placeholder="Style Name" value="${t.name}">\n                    <textarea class="text_pole atable-template-content atable-style-css" rows="5" placeholder="CSS Content">${t.css}</textarea>\n                </div>\n                <div class="menu_button menu_button_icon atable-delete-style" title="Delete this style">\n                    <i class="fa-solid fa-trash-can"></i>\n                </div>\n            </div>\n        `;e.append(a)}))}function z(){const e=$("#feinianyu_atable_template_list_container");e.empty(),E.templates.forEach(((t,n)=>{const a=0===n,i=a?"readonly":"",l=a?"disabled":"",o=a?"Default template cannot be deleted":"Delete this template",s=`\n            <div class="atable-template-item flex-container ${n===E.activeTemplateIndex?"atable-template-item-selected":""}" data-index="${n}">\n                <div class="atable-template-inputs">\n                    <input type="text" class="text_pole atable-template-name" placeholder="Template Name" value="${t.name}" ${i}>\n                    <textarea class="text_pole atable-template-content" rows="3" placeholder="Template Content" ${i}>${t.content}</textarea>\n                </div>\n                <div class="menu_button menu_button_icon atable-delete-template" title="${o}" ${l}>\n                    <i class="fa-solid fa-trash-can"></i>\n                </div>\n            </div>\n        `;e.append(s)}))}function L(){const e=$("#feinianyu_atable_prompt_template_list_container");e.empty(),E.promptTemplates.forEach(((t,n)=>{const a=0===n,i=a?"readonly":"",l=a?"disabled":"",o=a?"Default prompt cannot be deleted":"Delete this prompt",s=`\n            <div class="atable-template-item flex-container ${n===E.activePromptTemplateIndex?"atable-template-item-selected":""}" data-index="${n}">\n                <div class="atable-template-inputs">\n                    <input type="text" class="text_pole atable-prompt-template-name" placeholder="Template Name" value="${t.name}" ${i}>\n                    <textarea class="text_pole atable-template-content" rows="3" placeholder="Template Content" ${i}>${t.content}</textarea>\n                </div>\n                <div class="menu_button menu_button_icon atable-delete-prompt-template" title="${o}" ${l}>\n                    <i class="fa-solid fa-trash-can"></i>\n                </div>\n            </div>\n        `;e.append(s)}))}function R(){const e=E.enabled;if($("#feinianyu_atable_main_settings_container").toggleClass("disabled-content",!e),!e)return;const t=E.enableTemplateReplacement,n=E.autoInject;$("#feinianyu_atable_template_list_container, #feinianyu_atable_add_template").toggleClass("disabled-content",!t),$("#feinianyu_atable_prompt_template_list_container, #feinianyu_atable_add_prompt_template").toggleClass("disabled-content",!n)}function F(){w.init(),$("#feinianyu_atable_enabled").prop("checked",E.enabled),$("#feinianyu_atable_auto_inject").prop("checked",E.autoInject),$("#feinianyu_atable_enable_template_replacement").prop("checked",E.enableTemplateReplacement),$("#feinianyu_atable_nonHighlightedWords").val(E.nonHighlightedWords),z(),L(),N(),M(),H($("#feinianyu_atable_opening_tag_patterns_container"),E.openingTagPatterns),H($("#feinianyu_atable_closing_tag_patterns_container"),E.closingTagPatterns),R(),function(){$("#feinianyu_atable_enabled").on("change",(function(){E.enabled=this.checked,j(),R()})),$("#feinianyu_atable_auto_inject").on("change",(function(){E.autoInject=this.checked,j(),R()})),$("#feinianyu_atable_enable_template_replacement").on("change",(function(){E.enableTemplateReplacement=this.checked,j(),R()})),$("#feinianyu_atable_nonHighlightedWords").on("input",(function(){E.nonHighlightedWords=this.value,j()})),O("#feinianyu_atable_new_opening_tag_pattern","#feinianyu_atable_add_opening_tag_pattern","#feinianyu_atable_opening_tag_patterns_container",E.openingTagPatterns),O("#feinianyu_atable_new_closing_tag_pattern","#feinianyu_atable_add_closing_tag_pattern","#feinianyu_atable_closing_tag_patterns_container",E.closingTagPatterns),$("#feinianyu_atable_add_template").on("click",(function(){E.templates.push({name:"New Template",content:""}),E.activeTemplateIndex=E.templates.length-1,j(),z()}));const e=$("#feinianyu_atable_template_list_container");e.on("click",".atable-delete-template",(function(e){e.stopPropagation();const t=parseInt($(this).closest(".atable-template-item").data("index"),10);0!==t&&(E.templates.splice(t,1),E.activeTemplateIndex>=E.templates.length&&(E.activeTemplateIndex=E.templates.length-1),j(),z())})),e.on("click",".atable-template-item",(function(){const e=parseInt($(this).data("index"),10);E.activeTemplateIndex!==e&&(E.activeTemplateIndex=e,j(),z())})),e.on("input",".atable-template-name",(function(){const e=parseInt($(this).closest(".atable-template-item").data("index"),10);0!==e&&(E.templates[e].name=$(this).val(),j())})),e.on("input",".atable-template-content",(function(){const e=parseInt($(this).closest(".atable-template-item").data("index"),10);0!==e&&(E.templates[e].content=$(this).val(),j())})),$("#feinianyu_atable_add_prompt_template").on("click",(function(){E.promptTemplates.push({name:"New Prompt",content:""}),E.activePromptTemplateIndex=E.promptTemplates.length-1,j(),L()}));const t=$("#feinianyu_atable_prompt_template_list_container");t.on("click",".atable-delete-prompt-template",(function(e){e.stopPropagation();const t=parseInt($(this).closest(".atable-template-item").data("index"),10);0!==t&&(E.promptTemplates.splice(t,1),E.activePromptTemplateIndex>=E.promptTemplates.length&&(E.activePromptTemplateIndex=E.promptTemplates.length-1),j(),L())})),t.on("click",".atable-template-item",(function(){const e=parseInt($(this).data("index"),10);E.activePromptTemplateIndex!==e&&(E.activePromptTemplateIndex=e,j(),L())})),t.on("input",".atable-prompt-template-name",(function(){const e=parseInt($(this).closest(".atable-template-item").data("index"),10);0!==e&&(E.promptTemplates[e].name=$(this).val(),j())})),t.on("input",".atable-template-content",(function(){const e=parseInt($(this).closest(".atable-template-item").data("index"),10);0!==e&&(E.promptTemplates[e].content=$(this).val(),j())})),$("#feinianyu_atable_add_highlight_style").on("click",(function(){E.highlightStyles.push({name:"New Style",css:".atable-highlight {\n\n}"}),E.activeHighlightStyleIndex=E.highlightStyles.length-1,j(),N(),M()}));const n=$("#feinianyu_atable_highlight_style_list_container");n.on("click",".atable-delete-style",(function(e){e.stopPropagation();const t=parseInt($(this).closest(".atable-template-item").data("index"),10);E.highlightStyles.splice(t,1),E.activeHighlightStyleIndex>=E.highlightStyles.length&&(E.activeHighlightStyleIndex=E.highlightStyles.length-1),j(),N(),M()})),n.on("click",".atable-template-item",(function(){const e=parseInt($(this).data("index"),10);E.activeHighlightStyleIndex!==e&&(E.activeHighlightStyleIndex=e,j(),N(),M())})),n.on("input",".atable-style-name",(function(){const e=parseInt($(this).closest(".atable-template-item").data("index"),10);E.highlightStyles[e].name=$(this).val(),j()})),n.on("input",".atable-style-css",(function(){const e=parseInt($(this).closest(".atable-template-item").data("index"),10);E.highlightStyles[e].css=$(this).val(),j(),e===E.activeHighlightStyleIndex&&M()}))}(),w.log("UI module initialized, events bound.")}const D=e=>{if(E.enabled&&(1===e.nodeType&&e.matches(".mes")&&!e.dataset.atableProcessed)){w.log("Processing message element...");const t=e.querySelector(".mes_text");if(t){let e=t.innerHTML;const n=/\[at-list\](.*?)\[\/at-list\]/g,a=n.exec(e);if(a){const t=a[1]||"";w.log("Found at-list content:",t);const i=t.split(",").map((e=>e.trim())).filter((e=>e.length>0));P=i,w.log("Updated character list:",i),e=e.replace(n,"")}if(!E.openingTagPatterns?.length||!E.closingTagPatterns?.length)return;const i=E.openingTagPatterns.join("|"),l=E.closingTagPatterns.join("|"),o=new RegExp(`\\[(${i})([^\\]]*?)\\](.*?)(\\[(${l})\\])`,"gis"),s=E.nonHighlightedWords.split(",").map((e=>e.trim())),r=e.replace(o,((e,t,n,a,i)=>{const l=(e=>{const t={},n=/(\w+)=(?:"([^"]+)"|<q>"([^"]+)"<\/q>)/g;let a;for(;null!==(a=n.exec(e));)t[a[1]]=a[2]||a[3];return t})(n);return l.name&&!s.includes(a)?`<span class="atable-highlight" data-character-name="${l.name}">${a}</span>`:a}));t.innerHTML!==r&&(w.log("Applied at-tag highlighting to message."),t.innerHTML=r)}e.dataset.atableProcessed="true"}};let B;const W=()=>{const e=document.getElementById("chat");e?(B=new MutationObserver((e=>{const t=new Set;for(const n of e)if("childList"===n.type&&(n.addedNodes.forEach((e=>{if(1===e.nodeType)if(e.matches(".mes"))t.add(e);else{const n=e.closest(".mes");n&&t.add(n)}})),n.target&&n.target.closest)){const e=n.target.closest(".mes");e&&t.add(e)}t.forEach((e=>{delete e.dataset.atableProcessed,D(e)}))})),B.observe(e,{childList:!0,subtree:!0}),e.querySelectorAll(".mes").forEach((e=>D(e))),w.log("Successfully initialized MutationObserver on #chat.")):w.error("Initialization failed: Could not find #chat element. Chat processing will not work.")};let q,U;const{setExtensionPrompt:J}=globalThis.SillyTavern.getContext();async function Q(){w.log("Starting services..."),W(),await async function(){let e,t,n;try{e=(await import("/scripts/autocomplete/AutoComplete.js")).AutoComplete;const a=await import("/scripts/autocomplete/AutoCompleteOption.js");t=a.AutoCompleteOption;const i=await import("/scripts/autocomplete/AutoCompleteNameResult.js");n=i.AutoCompleteNameResult,w.log("Successfully loaded AutoComplete modules.")}catch(e){return w.error("Failed to load AutoComplete modules! Autocomplete will be disabled.",e),void toastr.error("Feinianyu-Atable failed to load AutoComplete functionality.")}const a=document.getElementById("send_textarea");q=new e(a,(()=>{if(!E.enabled||0===P.length)return!1;const e=a.value.substring(0,a.selectionStart),t=e.match(/@([^\s@]*)$/);if(t){const n=e.lastIndexOf(t[0]),a=0===n||/\s/.test(e.charAt(n-1));return a&&w.log("AutoComplete activation check passed."),a}return!1}),(async(e,a)=>{const i=e.substring(0,a),l=i.match(/@([^\s@]*)$/);if(!l)return null;const o=l[1];w.log("AutoComplete search term:",o);const s=i.lastIndexOf(l[0]),r=(o?P.filter((e=>e.startsWith(o))):P).map((e=>new t(e,"@","")));return new n(o,s+1,r,{canBeQuoted:!1})}),!1),q.select=async function(){if(this.isReplaceable&&null!==this.selectedItem.value){const e=this.selectedItem.value,t=this.textarea.value,n=this.effectiveParserResult.start-1,a=n+this.effectiveParserResult.name.length+1;this.textarea.value=`${t.slice(0,n)}@${e} ${t.slice(a)}`;const i=n+1+e.length+1;this.textarea.selectionStart=i,this.textarea.selectionEnd=i,this.textarea.dispatchEvent(new Event("input",{bubbles:!0})),this.hide()}},w.log("AutoComplete instance created."),$("#chat").on("click.atable",".atable-highlight",(function(){if(!E.enabled)return;const e=$(this).data("character-name");if(e){const t=document.getElementById("send_textarea"),n=t.value,a=t.selectionStart,i=t.selectionEnd,l="@"+e+" ",o=(a>0&&!/\s$/.test(n.substring(0,a))?" ":"")+l;t.value=n.substring(0,a)+o+n.substring(i);const s=a+o.length;t.selectionStart=s,t.selectionEnd=s,t.focus(),t.dispatchEvent(new Event("input",{bubbles:!0})),w.log(`Inserted "${e}" into textarea at position ${a}.`)}})),w.log("Click handler for highlighted names is active."),U=function(e){if(e.target.closest("#send_but")){if(!E.enabled||!E.enableTemplateReplacement)return;const e=$("#send_textarea");let t=e.val();if(!t.includes("@"))return;w.log("Send intercepted for potential @message processing."),w.log("Original message:",t);const n=E.templates[E.activeTemplateIndex];if(!n||!n.content||""===n.content.trim())return w.warn("Active @template is empty. Sending message as is."),void toastr.warning("Atable: Active send template is empty.");if(!n.content.includes("{{name}}")&&!n.content.includes("{{content}}"))return w.error("Active @template is invalid (missing {{name}} or {{content}}). Sending message as is."),void toastr.error("Atable: Active send template is invalid.");try{let a="";const i=/@(\S+)\s*([^@]*)/g;let l,o=0;for(;null!==(l=i.exec(t));){a+=t.substring(o,l.index);const e=l[1],i=l[2].trim();a+=n.content.replace("{{name}}",e).replace("{{content}}",i),o=l.index+l[0].length}o<t.length&&(a+=t.substring(o)),e.val(a),w.log("Transformed message:",a)}catch(e){w.error("Error applying template:",e),toastr.error("Atable: Failed to apply send template.")}}},document.addEventListener("mousedown",U,!0),w.log("Send interceptor has been attached.")}()}function G(){w.log("Stopping services..."),B&&(B.disconnect(),B=null,w.log("MutationObserver stopped.")),q&&(q.hide(),q=null),$("#chat").off("click.atable"),U&&(document.removeEventListener("mousedown",U,!0),U=null),w.log("Input handlers stopped."),J(A,"",0),w.log("Cleared extension prompt.")}globalThis.feinianyuAtableInterceptor=(e,t,n,a)=>{const i=function(){const e=E.promptTemplates[E.activePromptTemplateIndex];return E.enabled&&E.autoInject&&e&&""!==e.content.trim()?e.content:null}();if(i){const e=2;w.log("Auto-injecting prompt."),J(A,i,e)}},jQuery((async()=>{try{await new Promise((e=>{const t=setInterval((()=>{$("#chat").length&&$("#extensions_settings").length&&$("#send_textarea").length&&(clearInterval(t),e())}),100)})),w.log("Core UI ready. Initializing extension..."),$("#extensions_settings").append('<style>.collapsible-help{margin-top:8px;margin-bottom:5px;width:100%}.collapsible-help summary{display:flex;align-items:center;padding:2px 0;cursor:pointer;outline:0;-webkit-tap-highlight-color:transparent}.collapsible-help summary::-webkit-details-marker{display:none}.collapsible-help summary{list-style:none}.summary-indicator{width:0;height:0;border-left:5px solid transparent;border-right:5px solid transparent;border-top:5px solid currentColor;margin-right:8px;opacity:.7;transform-origin:center;transition:transform .2s ease-in-out}.collapsible-help details[open]>summary .summary-indicator{transform:rotate(180deg)}.summary-title{color:var(--text-secondary-color,#b9b9b9);font-size:.9em;transition:color .2s ease}.collapsible-help summary:hover .summary-title{color:var(--link-color,#8ab4f8)}.details-content{padding-left:18px;padding-bottom:5px}.details-content p{font-size:.9em;color:var(--text-secondary-color,#b9b9b9);line-height:1.6;margin:5px 0 0 0}.details-content p b{color:var(--text-color,#e1e1e1)}.disabled-content{opacity:.6;pointer-events:none}#atable-log-textarea{font-size:.65em;line-height:1.4}</style> <div class="feinianyu-atable-settings"> <div class="inline-drawer"> <div class="inline-drawer-toggle inline-drawer-header"> <b>Atable 插件设置</b> <div class="inline-drawer-icon fa-solid fa-circle-chevron-down"></div> </div> <div class="inline-drawer-content"> <div class="setting_item"> <label for="feinianyu_atable_enabled" class="flex-container"> <input type="checkbox" id="feinianyu_atable_enabled"> <span>启用 Atable 插件</span> </label> </div> <hr> <div id="feinianyu_atable_main_settings_container"> <div class="form_group_boxtitle">输入增强</div> <div class="setting_item"> <label for="feinianyu_atable_enable_template_replacement" class="flex-container"> <input type="checkbox" id="feinianyu_atable_enable_template_replacement"> <span>启用输入增强</span> </label> <div class="collapsible-help"> <details> <summary> <div class="summary-indicator"></div> <span class="summary-title">这是什么？</span> </summary> <div class="details-content"> <p>启用后，在输入框中键入的 "@角色名 内容" 将在发送时被替换为下方选定的模板格式。其中 {{name}} 为名字，{{content}} 宏为内容</p> <p>例如：当启用了默认模板时</p> <p>在输入框输入：今天天气真好 @张三 要出去走走吗？ @李四 你呢？</p> <p>会被替换为：今天天气真好 （我对张三说）要出去走走吗？ （我对李四说）你呢？</p> </div> </details> </div> </div> <div class="form-group"> <label>发送模板管理 (点击选择激活的模板)</label> <div id="feinianyu_atable_template_list_container"> </div> <div id="feinianyu_atable_add_template" class="menu_button menu_button_icon"> <i class="fa-solid fa-plus"></i> <span>添加新模板</span> </div> </div> <hr> <div class="form_group_boxtitle">聊天显示与渲染</div> <div class="form-group"> <label for="feinianyu_atable_nonHighlightedWords">不高亮词汇</label> <p class="description">在这里输入不希望被高亮的词语，用英文逗号分隔。例如：你,我,他,她</p> <input type="text" id="feinianyu_atable_nonHighlightedWords" class="text_pole"> </div> <div class="form-group"> <label>高亮样式管理 (点击选择激活的样式)</label> <div id="feinianyu_atable_highlight_style_list_container"> </div> <div id="feinianyu_atable_add_highlight_style" class="menu_button menu_button_icon"> <i class="fa-solid fa-plus"></i> <span>添加新样式</span> </div> </div> <hr> <div class="form_group_boxtitle">AI 提示词</div> <div class="setting_item"> <label for="feinianyu_atable_auto_inject" class="flex-container"> <input type="checkbox" id="feinianyu_atable_auto_inject"> <span>自动注入提示词</span> </label> <div class="collapsible-help"> <details> <summary> <div class="summary-indicator"></div> <span class="summary-title">这是什么？如何使用？</span> </summary> <div class="details-content"> <p>启用后，每次发送消息都会自动在最终提示词中加入下方选定的指令，以引导AI返回特定格式。</p> <p><b>例如：</b>你可以创建一个提示词，要求AI在回复中用特定标签包裹角色名，这样插件才能识别并高亮它们。</p> <p>选择一个下方激活的模板，它将在生成回复时被自动添加到你的主输入内容的末尾。</p> </div> </details> </div> </div> <div class="form-group"> <label>提示词模板管理 (点击选择激活的模板)</label> <div id="feinianyu_atable_prompt_template_list_container"> </div> <div class="menu_button menu_button_icon" id="feinianyu_atable_add_prompt_template"> <i class="fa-solid fa-plus"></i> <span>添加新提示词</span> </div> </div> <hr> <div class="form_group_boxtitle">高级：自定义渲染规则</div> <div class="collapsible-help"> <details> <summary> <div class="summary-indicator"></div> <span class="summary-title">这是什么？</span> </summary> <div class="details-content"> <p>这里定义了插件如何从AI的回复中识别出需要高亮的内容。通常不需要修改。如果AI总是返回无法被解析的标签，可以在这里加入。</p> <p>例如：AI 总是返回 [at-tah name = "xxx"] ... [/at-tag]</p> <p>那么可以将 at-tah 加入到 开始标签匹配模式 中。 </p></div> </details> </div> <div class="form-group"> <label>开始标签匹配模式</label> <div id="feinianyu_atable_opening_tag_patterns_container" class="tag-container"> </div> <div class="add-tag-container"> <input type="text" id="feinianyu_atable_new_opening_tag_pattern" class="text_pole" placeholder="输入模式后按回车或点击添加"> <div id="feinianyu_atable_add_opening_tag_pattern" class="menu_button menu_button_icon"> <i class="fa-solid fa-plus"></i> <span>添加</span> </div> </div> </div> <div class="form-group"> <label>结束标签匹配模式</label> <div id="feinianyu_atable_closing_tag_patterns_container" class="tag-container"> </div> <div class="add-tag-container"> <input type="text" id="feinianyu_atable_new_closing_tag_pattern" class="text_pole" placeholder="输入模式后按回车或点击添加"> <div id="feinianyu_atable_add_closing_tag_pattern" class="menu_button menu_button_icon"> <i class="fa-solid fa-plus"></i> <span>添加</span> </div> </div> </div> </div> <hr> <div class="form_group_boxtitle">插件日志</div> <div class="collapsible-help"> <details> <summary> <div class="summary-indicator"></div> <span class="summary-title">显示/隐藏日志</span> </summary> <div class="details-content"> <div class="atable-log-controls" style="margin-bottom:10px;display:flex;gap:10px"> <div id="atable-copy-log" class="menu_button menu_button_icon"> <i class="fa-solid fa-copy"></i> <span>复制日志</span> </div> </div> <textarea id="atable-log-textarea" readonly="readonly" rows="15" class="text_pole" style="width:100%;resize:vertical"></textarea> </div> </details> </div> </div> </div> </div> '),$("#feinianyu_atable_dynamic_styles").length||$("head").append('<style id="feinianyu_atable_dynamic_styles"></style>'),F(),E.enabled&&await Q(),$("#feinianyu_atable_enabled").on("change",(async function(){this.checked?await Q():G()})),w.log("Extension fully initialized and interceptor is globally available.")}catch(e){console.error("[Feinianyu-Atable] A fatal error occurred during extension initialization:",e),toastr.error("Feinianyu-Atable failed to load. Please check the browser console (F12) for more details.","Extension Error")}}))})();