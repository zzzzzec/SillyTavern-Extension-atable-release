(()=>{"use strict";const{extensionSettings:e,saveSettingsDebounced:t}=globalThis.SillyTavern.getContext(),n="feinianyu-atable",a=Object.freeze({enabled:!0,nonHighlightedWords:"你,我,他,她",openingTagPatterns:["at-tag"],closingTagPatterns:["/at-tag"],autoInject:!0,enableTemplateReplacement:!0,activeTemplateIndex:0,templates:[{name:"默认模板",content:"(我对{{name}}说){{content}}"}],activePromptTemplateIndex:0,promptTemplates:[{name:"默认提示词",content:"默认提示词"}],activeHighlightStyleIndex:0,highlightStyles:[{name:"金黄色",css:".atable-highlight {\n    background-color: rgba(255, 215, 0, 0.4);\n    padding: 1px 4px;\n    border-radius: 5px;\n    cursor: pointer;\n    transition: background-color 0.2s ease;\n    font-weight: bold;\n    box-shadow: 0 0 5px rgba(255, 215, 0, 0.7);\n}"},{name:"Brand Blue",css:".atable-highlight {\n    color: #4a90e2;\n    background-color: rgba(74, 144, 226, 0.1);\n    padding: 1px 4px;\n    border-radius: 5px;\n    cursor: pointer;\n    font-weight: bold;\n}"},{name:"Neon Cyan",css:".atable-highlight {\n    color: #00ffff;\n    background-color: rgba(0, 255, 255, 0.1);\n    padding: 1px 4px;\n    border-radius: 3px;\n    border: 1px solid rgba(0, 255, 255, 0.3);\n    cursor: pointer;\n    text-shadow: 0 0 3px #00ffff;\n}"},{name:"下划线",css:".atable-highlight {\n    text-decoration: underline;\n    text-decoration-color: #4a90e2;\n    text-decoration-thickness: 2px;\n    cursor: pointer;\n    font-weight: bold;\n    background-color: transparent;\n}"}]});const l=function(){e[n]||(e[n]=structuredClone(a));const l=e[n];l.sendFormat&&!l.templates&&(console.log("[feinianyu-atable] Migrating old settings for send templates..."),l.templates=[{name:"Imported Template",content:l.sendFormat}],l.activeTemplateIndex=0,delete l.sendFormat,t());for(const e of Object.keys(a))Object.hasOwn(l,e)||(l[e]=a[e]);return l}();let i=[];const{saveSettingsDebounced:s}=globalThis.SillyTavern.getContext();function o(e,t){e.empty(),t.forEach(((t,n)=>{const a=`\n            <div class="tag-item">\n                <span>${t}</span>\n                ${0===n?"":`<span class="delete-tag" data-index="${n}" title="Delete pattern">✖</span>`}\n            </div>\n        `;e.append(a)}))}function c(e,t,n,a){const l=$(e),i=$(t),c=$(n),r=()=>{const e=l.val().trim();e&&!a.includes(e)&&(a.push(e),s(),o(c,a),l.val(""))};i.on("click",r),l.on("keypress",(function(e){13===e.which&&r()})),c.on("click",".delete-tag",(function(){const e=parseInt($(this).data("index"),10);0!==e&&(a.splice(e,1),s(),o(c,a))}))}function r(){const e=l.highlightStyles[l.activeHighlightStyleIndex];e&&e.css?$("#feinianyu_atable_dynamic_styles").text(e.css):$("#feinianyu_atable_dynamic_styles").text("")}function p(){const e=$("#feinianyu_atable_highlight_style_list_container");e.empty(),l.highlightStyles.forEach(((t,n)=>{const a=`\n            <div class="atable-template-item flex-container ${n===l.activeHighlightStyleIndex?"atable-template-item-selected":""}" data-index="${n}">\n                <div class="atable-template-inputs">\n                    <input type="text" class="text_pole atable-style-name" placeholder="Style Name" value="${t.name}">\n                    <textarea class="text_pole atable-template-content atable-style-css" rows="5" placeholder="CSS Content">${t.css}</textarea>\n                </div>\n                <div class="menu_button menu_button_icon atable-delete-style" title="Delete this style">\n                    <i class="fa-solid fa-trash-can"></i>\n                </div>\n            </div>\n        `;e.append(a)}))}function d(){const e=$("#feinianyu_atable_template_list_container");e.empty(),l.templates.forEach(((t,n)=>{const a=0===n,i=a?"readonly":"",s=a?"disabled":"",o=a?"Default template cannot be deleted":"Delete this template",c=`\n            <div class="atable-template-item flex-container ${n===l.activeTemplateIndex?"atable-template-item-selected":""}" data-index="${n}">\n                <div class="atable-template-inputs">\n                    <input type="text" class="text_pole atable-template-name" placeholder="Template Name" value="${t.name}" ${i}>\n                    <textarea class="text_pole atable-template-content" rows="3" placeholder="Template Content" ${i}>${t.content}</textarea>\n                </div>\n                <div class="menu_button menu_button_icon atable-delete-template" title="${o}" ${s}>\n                    <i class="fa-solid fa-trash-can"></i>\n                </div>\n            </div>\n        `;e.append(c)}))}function m(){const e=$("#feinianyu_atable_prompt_template_list_container");e.empty(),l.promptTemplates.forEach(((t,n)=>{const a=0===n,i=a?"readonly":"",s=a?"disabled":"",o=a?"Default prompt cannot be deleted":"Delete this prompt",c=`\n            <div class="atable-template-item flex-container ${n===l.activePromptTemplateIndex?"atable-template-item-selected":""}" data-index="${n}">\n                <div class="atable-template-inputs">\n                    <input type="text" class="text_pole atable-prompt-template-name" placeholder="Template Name" value="${t.name}" ${i}>\n                    <textarea class="text_pole atable-template-content" rows="3" placeholder="Template Content" ${i}>${t.content}</textarea>\n                </div>\n                <div class="menu_button menu_button_icon atable-delete-prompt-template" title="${o}" ${s}>\n                    <i class="fa-solid fa-trash-can"></i>\n                </div>\n            </div>\n        `;e.append(c)}))}function u(){const e=l.enabled;if($("#feinianyu_atable_main_settings_container").toggleClass("disabled-content",!e),!e)return;const t=l.enableTemplateReplacement,n=l.autoInject;$("#feinianyu_atable_template_list_container, #feinianyu_atable_add_template").toggleClass("disabled-content",!t),$("#feinianyu_atable_prompt_template_list_container, #feinianyu_atable_add_prompt_template").toggleClass("disabled-content",!n)}function g(){$("#feinianyu_atable_enabled").prop("checked",l.enabled),$("#feinianyu_atable_auto_inject").prop("checked",l.autoInject),$("#feinianyu_atable_enable_template_replacement").prop("checked",l.enableTemplateReplacement),$("#feinianyu_atable_nonHighlightedWords").val(l.nonHighlightedWords),d(),m(),p(),r(),o($("#feinianyu_atable_opening_tag_patterns_container"),l.openingTagPatterns),o($("#feinianyu_atable_closing_tag_patterns_container"),l.closingTagPatterns),u(),function(){$("#feinianyu_atable_enabled").on("change",(function(){l.enabled=this.checked,s(),u()})),$("#feinianyu_atable_auto_inject").on("change",(function(){l.autoInject=this.checked,s(),u()})),$("#feinianyu_atable_enable_template_replacement").on("change",(function(){l.enableTemplateReplacement=this.checked,s(),u()})),$("#feinianyu_atable_nonHighlightedWords").on("input",(function(){l.nonHighlightedWords=this.value,s()})),c("#feinianyu_atable_new_opening_tag_pattern","#feinianyu_atable_add_opening_tag_pattern","#feinianyu_atable_opening_tag_patterns_container",l.openingTagPatterns),c("#feinianyu_atable_new_closing_tag_pattern","#feinianyu_atable_add_closing_tag_pattern","#feinianyu_atable_closing_tag_patterns_container",l.closingTagPatterns),$("#feinianyu_atable_add_template").on("click",(function(){l.templates.push({name:"New Template",content:""}),l.activeTemplateIndex=l.templates.length-1,s(),d()}));const e=$("#feinianyu_atable_template_list_container");e.on("click",".atable-delete-template",(function(e){e.stopPropagation();const t=parseInt($(this).closest(".atable-template-item").data("index"),10);0!==t&&(l.templates.splice(t,1),l.activeTemplateIndex>=l.templates.length&&(l.activeTemplateIndex=l.templates.length-1),s(),d())})),e.on("click",".atable-template-item",(function(){const e=parseInt($(this).data("index"),10);l.activeTemplateIndex!==e&&(l.activeTemplateIndex=e,s(),d())})),e.on("input",".atable-template-name",(function(){const e=parseInt($(this).closest(".atable-template-item").data("index"),10);0!==e&&(l.templates[e].name=$(this).val(),s())})),e.on("input",".atable-template-content",(function(){const e=parseInt($(this).closest(".atable-template-item").data("index"),10);0!==e&&(l.templates[e].content=$(this).val(),s())})),$("#feinianyu_atable_add_prompt_template").on("click",(function(){l.promptTemplates.push({name:"New Prompt",content:""}),l.activePromptTemplateIndex=l.promptTemplates.length-1,s(),m()}));const t=$("#feinianyu_atable_prompt_template_list_container");t.on("click",".atable-delete-prompt-template",(function(e){e.stopPropagation();const t=parseInt($(this).closest(".atable-template-item").data("index"),10);0!==t&&(l.promptTemplates.splice(t,1),l.activePromptTemplateIndex>=l.promptTemplates.length&&(l.activePromptTemplateIndex=l.promptTemplates.length-1),s(),m())})),t.on("click",".atable-template-item",(function(){const e=parseInt($(this).data("index"),10);l.activePromptTemplateIndex!==e&&(l.activePromptTemplateIndex=e,s(),m())})),t.on("input",".atable-prompt-template-name",(function(){const e=parseInt($(this).closest(".atable-template-item").data("index"),10);0!==e&&(l.promptTemplates[e].name=$(this).val(),s())})),t.on("input",".atable-template-content",(function(){const e=parseInt($(this).closest(".atable-template-item").data("index"),10);0!==e&&(l.promptTemplates[e].content=$(this).val(),s())})),$("#feinianyu_atable_add_highlight_style").on("click",(function(){l.highlightStyles.push({name:"New Style",css:".atable-highlight {\n\n}"}),l.activeHighlightStyleIndex=l.highlightStyles.length-1,s(),p(),r()}));const n=$("#feinianyu_atable_highlight_style_list_container");n.on("click",".atable-delete-style",(function(e){e.stopPropagation();const t=parseInt($(this).closest(".atable-template-item").data("index"),10);l.highlightStyles.splice(t,1),l.activeHighlightStyleIndex>=l.highlightStyles.length&&(l.activeHighlightStyleIndex=l.highlightStyles.length-1),s(),p(),r()})),n.on("click",".atable-template-item",(function(){const e=parseInt($(this).data("index"),10);l.activeHighlightStyleIndex!==e&&(l.activeHighlightStyleIndex=e,s(),p(),r())})),n.on("input",".atable-style-name",(function(){const e=parseInt($(this).closest(".atable-template-item").data("index"),10);l.highlightStyles[e].name=$(this).val(),s()})),n.on("input",".atable-style-css",(function(){const e=parseInt($(this).closest(".atable-template-item").data("index"),10);l.highlightStyles[e].css=$(this).val(),s(),e===l.activeHighlightStyleIndex&&r()}))}()}const h=e=>{if(l.enabled&&(1===e.nodeType&&e.matches(".mes")&&!e.dataset.atableProcessed)){const t=e.querySelector(".mes_text");if(t){let e=t.innerHTML;const n=/\[at-list\](.*?)\[\/at-list\]/g,a=n.exec(e);if(a){const t=(a[1]||"").split(",").map((e=>e.trim())).filter((e=>e.length>0));i=t,console.log("[feinianyu-atable] Updated character list:",t),e=e.replace(n,"")}if(!l.openingTagPatterns?.length||!l.closingTagPatterns?.length)return;const s=l.openingTagPatterns.join("|"),o=l.closingTagPatterns.join("|"),c=new RegExp(`\\[(${s})([^\\]]*?)\\](.*?)(\\[(${o})\\])`,"gis"),r=l.nonHighlightedWords.split(",").map((e=>e.trim())),p=e.replace(c,((e,t,n,a,l)=>{const i=(e=>{const t={},n=/(\w+)=(?:"([^"]+)"|<q>"([^"]+)"<\/q>)/g;let a;for(;null!==(a=n.exec(e));)t[a[1]]=a[2]||a[3];return t})(n);return i.name&&!r.includes(a)?`<span class="atable-highlight" data-character-name="${i.name}">${a}</span>`:a}));t.innerHTML!==p&&(t.innerHTML=p)}e.dataset.atableProcessed="true"}};let b;const f=()=>{const e=document.getElementById("chat");e&&(b=new MutationObserver((e=>{const t=new Set;for(const n of e)if("childList"===n.type&&(n.addedNodes.forEach((e=>{if(1===e.nodeType)if(e.matches(".mes"))t.add(e);else{const n=e.closest(".mes");n&&t.add(n)}})),n.target&&n.target.closest)){const e=n.target.closest(".mes");e&&t.add(e)}t.forEach((e=>{delete e.dataset.atableProcessed,h(e)}))})),b.observe(e,{childList:!0,subtree:!0}),e.querySelectorAll(".mes").forEach((e=>h(e))),console.log("[feinianyu-atable] MutationObserver is now watching #chat."))};let _,y;const{setExtensionPrompt:x}=globalThis.SillyTavern.getContext();function v(){console.log("[feinianyu-atable] Starting services..."),f(),async function(){let e,t,n;try{e=(await import("/scripts/autocomplete/AutoComplete.js")).AutoComplete;const a=await import("/scripts/autocomplete/AutoCompleteOption.js");t=a.AutoCompleteOption;const l=await import("/scripts/autocomplete/AutoCompleteNameResult.js");n=l.AutoCompleteNameResult}catch(e){return console.error("[feinianyu-atable] Failed to load AutoComplete modules!",e),void toastr.error("Feinianyu-Atable failed to load AutoComplete functionality.")}const a=document.getElementById("send_textarea");_=new e(a,(()=>{if(!l.enabled||0===i.length)return!1;const e=a.value.substring(0,a.selectionStart),t=e.match(/@([^\s@]*)$/);if(t){const n=e.lastIndexOf(t[0]);return 0===n||/\s/.test(e.charAt(n-1))}return!1}),(async(e,a)=>{const l=e.substring(0,a),s=l.match(/@([^\s@]*)$/);if(!s)return null;const o=s[1],c=l.lastIndexOf(s[0]),r=(o?i.filter((e=>e.startsWith(o))):i).map((e=>new t(e,"@","")));return new n(o,c+1,r,{canBeQuoted:!1})}),!1),_.select=async function(){if(this.isReplaceable&&null!==this.selectedItem.value){const e=this.selectedItem.value,t=this.textarea.value,n=this.effectiveParserResult.start-1,a=n+this.effectiveParserResult.name.length+1;this.textarea.value=`${t.slice(0,n)}@${e} ${t.slice(a)}`;const l=n+1+e.length+1;this.textarea.selectionStart=l,this.textarea.selectionEnd=l,this.textarea.dispatchEvent(new Event("input",{bubbles:!0})),this.hide()}},$("#chat").on("click.atable",".atable-highlight",(function(){if(!l.enabled)return;const e=$(this).data("character-name");if(e){const t=$("#send_textarea");t.val(t.val()+"@"+e+" "),t.focus()}})),y=function(e){if(e.target.closest("#send_but")){if(!l.enabled||!l.enableTemplateReplacement)return;const e=$("#send_textarea");let t=e.val();if(!t.includes("@"))return;console.log("[feinianyu-atable] Intercepting send for @ message.");const n=l.templates[l.activeTemplateIndex];if(!n||!n.content||""===n.content.trim())return void toastr.error("Active @template is empty. Sending message as is.");if(!n.content.includes("{{name}}")&&!n.content.includes("{{content}}"))return toastr.error("Active @template is invalid (missing {{name}} or {{content}}). Sending message as is."),void console.log("[feinianyu-atable] Template validation failed: placeholders missing.");try{let a="";const l=/@(\S+)\s*([^@]*)/g;let i,s=0;for(;null!==(i=l.exec(t));){a+=t.substring(s,i.index);const e=i[1],l=i[2].trim();a+=n.content.replace("{{name}}",e).replace("{{content}}",l),s=i.index+i[0].length}s<t.length&&(a+=t.substring(s)),e.val(a)}catch(e){toastr.error("Failed to apply @template. Sending message as is."),console.error("[feinianyu-atable] Error applying template:",e)}}},document.addEventListener("mousedown",y,!0)}()}function T(){console.log("[feinianyu-atable] Stopping services..."),b&&(b.disconnect(),b=null,console.log("[feinianyu-atable] MutationObserver stopped.")),_&&(_.hide(),_=null),$("#chat").off("click.atable"),y&&(document.removeEventListener("mousedown",y,!0),y=null),console.log("[feinianyu-atable] Input handlers stopped."),x(n,"",0),console.log("[feinianyu-atable] Cleared extension prompt.")}globalThis.feinianyuAtableInterceptor=(e,t,a,i)=>{const s=function(){const e=l.promptTemplates[l.activePromptTemplateIndex];return l.enabled&&l.autoInject&&e&&""!==e.content.trim()?e.content:null}();if(s){const e=2;console.log("[feinianyu-atable] Auto-injecting prompt."),x(n,s,e)}},jQuery((async()=>{await new Promise((e=>{const t=setInterval((()=>{$("#chat").length&&$("#extensions_settings").length&&$("#send_textarea").length&&(clearInterval(t),e())}),100)})),console.log("[feinianyu-atable] Core UI ready. Initializing extension...");const e=await $.get("scripts/extensions/third-party/Feinianyu-atable/src/index.html");$("#extensions_settings").append(e),$("#feinianyu_atable_dynamic_styles").length||$("head").append('<style id="feinianyu_atable_dynamic_styles"></style>'),g(),l.enabled&&v(),$("#feinianyu_atable_enabled").on("change",(function(){this.checked?v():T()})),console.log("[feinianyu-atable] Extension fully initialized and interceptor is globally available.")}))})();