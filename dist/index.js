(()=>{"use strict";var e={208:(e,t,n)=>{n.d(t,{A:()=>s});var a=n(601),i=n.n(a),l=n(314),o=n.n(l)()(i());o.push([e.id,"/* 基础高亮样式 */\n.atable-highlight {\n    background-color: rgba(255, 215, 0, 0.4); /* 金色背景，带透明度 */\n    padding: 1px 4px;\n    border-radius: 5px;\n    cursor: pointer;\n    transition: background-color 0.2s ease;\n    font-weight: bold;\n}\n\n.atable-highlight:hover {\n    background-color: rgba(255, 215, 0, 0.6); /* 鼠标悬停时加深背景色 */\n}\n\n/* 模板列表项样式 */\n.atable-template-content {\n    max-height: 150px; /* 设置一个最大高度 */\n    overflow-y: auto;  /* 当内容超出时，显示垂直滚动条 */\n    resize: vertical;  /* 允许用户垂直调整大小 */\n}\n\n.atable-template-item {\n    margin-bottom: 8px;\n    align-items: stretch;\n    border: 1px solid var(--border-color, #cccccc);\n    border-radius: 5px;\n    padding: 8px;\n    transition: border-color 0.2s, background-color 0.2s;\n    cursor: pointer;\n}\n\n.atable-template-inputs {\n    flex: 1;\n    display: flex;\n    flex-direction: column;\n    margin-right: 8px;\n}\n\n.atable-template-name {\n    margin-bottom: 5px;\n    font-weight: bold;\n}\n\n.atable-delete-template {\n    align-self: center;\n}\n\n/* 模板选中时的高亮样式 */\n.atable-template-item-selected {\n    border-color: var(--link-color, #4a90e2);\n    background-color: rgba(var(--link-color-rgb, 74, 144, 226), 0.1);\n}\n\n/* 用于禁用UI区域的样式 */\n.disabled-section {\n    opacity: 0.6;\n    pointer-events: none;\n}\n\n/* Tag container styles */\n.tag-container {\n    display: flex;\n    flex-wrap: wrap;\n    gap: 5px;\n    margin-top: 5px;\n    margin-bottom: 10px;\n}\n\n.tag-item {\n    background-color: var(--background-color-secondary);\n    border: 1px solid var(--border-color);\n    border-radius: 5px;\n    padding: 5px 10px;\n    display: flex;\n    align-items: center;\n    gap: 8px;\n}\n\n.tag-item .delete-tag {\n    cursor: pointer;\n    font-weight: bold;\n    color: var(--text-color-secondary);\n}\n\n.tag-item .delete-tag:hover {\n    color: var(--text-color);\n}\n\n.add-tag-container {\n    display: flex;\n    gap: 10px;\n    align-items: center;\n}\n\n.add-tag-container .text_pole {\n    flex-grow: 1;\n}\n",""]);const s=o},314:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var n="",a=void 0!==t[5];return t[4]&&(n+="@supports (".concat(t[4],") {")),t[2]&&(n+="@media ".concat(t[2]," {")),a&&(n+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),n+=e(t),a&&(n+="}"),t[2]&&(n+="}"),t[4]&&(n+="}"),n})).join("")},t.i=function(e,n,a,i,l){"string"==typeof e&&(e=[[null,e,void 0]]);var o={};if(a)for(var s=0;s<this.length;s++){var r=this[s][0];null!=r&&(o[r]=!0)}for(var c=0;c<e.length;c++){var p=[].concat(e[c]);a&&o[p[0]]||(void 0!==l&&(void 0===p[5]||(p[1]="@layer".concat(p[5].length>0?" ".concat(p[5]):""," {").concat(p[1],"}")),p[5]=l),n&&(p[2]?(p[1]="@media ".concat(p[2]," {").concat(p[1],"}"),p[2]=n):p[2]=n),i&&(p[4]?(p[1]="@supports (".concat(p[4],") {").concat(p[1],"}"),p[4]=i):p[4]="".concat(i)),t.push(p))}},t}},601:e=>{e.exports=function(e){return e[1]}},72:e=>{var t=[];function n(e){for(var n=-1,a=0;a<t.length;a++)if(t[a].identifier===e){n=a;break}return n}function a(e,a){for(var l={},o=[],s=0;s<e.length;s++){var r=e[s],c=a.base?r[0]+a.base:r[0],p=l[c]||0,d="".concat(c," ").concat(p);l[c]=p+1;var u=n(d),m={css:r[1],media:r[2],sourceMap:r[3],supports:r[4],layer:r[5]};if(-1!==u)t[u].references++,t[u].updater(m);else{var g=i(m,a);a.byIndex=s,t.splice(s,0,{identifier:d,updater:g,references:1})}o.push(d)}return o}function i(e,t){var n=t.domAPI(t);n.update(e);return function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;n.update(e=t)}else n.remove()}}e.exports=function(e,i){var l=a(e=e||[],i=i||{});return function(e){e=e||[];for(var o=0;o<l.length;o++){var s=n(l[o]);t[s].references--}for(var r=a(e,i),c=0;c<l.length;c++){var p=n(l[c]);0===t[p].references&&(t[p].updater(),t.splice(p,1))}l=r}}},659:e=>{var t={};e.exports=function(e,n){var a=function(e){if(void 0===t[e]){var n=document.querySelector(e);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(e){n=null}t[e]=n}return t[e]}(e);if(!a)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");a.appendChild(n)}},540:e=>{e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},56:(e,t,n)=>{e.exports=function(e){var t=n.nc;t&&e.setAttribute("nonce",t)}},825:e=>{e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=e.insertStyleElement(e);return{update:function(n){!function(e,t,n){var a="";n.supports&&(a+="@supports (".concat(n.supports,") {")),n.media&&(a+="@media ".concat(n.media," {"));var i=void 0!==n.layer;i&&(a+="@layer".concat(n.layer.length>0?" ".concat(n.layer):""," {")),a+=n.css,i&&(a+="}"),n.media&&(a+="}"),n.supports&&(a+="}");var l=n.sourceMap;l&&"undefined"!=typeof btoa&&(a+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(l))))," */")),t.styleTagTransform(a,e,t.options)}(t,e,n)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}},113:e=>{e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}}},t={};function n(a){var i=t[a];if(void 0!==i)return i.exports;var l=t[a]={id:a,exports:{}};return e[a](l,l.exports,n),l.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var a in t)n.o(t,a)&&!n.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.nc=void 0;var a=n(72),i=n.n(a),l=n(825),o=n.n(l),s=n(659),r=n.n(s),c=n(56),p=n.n(c),d=n(540),u=n.n(d),m=n(113),g=n.n(m),b=n(208),h={};h.styleTagTransform=g(),h.setAttributes=p(),h.insert=r().bind(null,"head"),h.domAPI=o(),h.insertStyleElement=u();i()(b.A,h);b.A&&b.A.locals&&b.A.locals;const{extensionSettings:f,saveSettingsDebounced:_}=globalThis.SillyTavern.getContext(),v="feinianyu-atable",y=Object.freeze({enabled:!0,nonHighlightedWords:"你,我,他,她",openingTagPatterns:["at-tag"],closingTagPatterns:["/at-tag"],autoInject:!0,enableTemplateReplacement:!0,activeTemplateIndex:0,templates:[{name:"默认模板",content:"(我对{{name}}说){{content}}"}],activePromptTemplateIndex:0,promptTemplates:[{name:"默认提示词",content:"默认提示词"}],activeHighlightStyleIndex:0,highlightStyles:[{name:"金黄色",css:".atable-highlight {\n    background-color: rgba(255, 215, 0, 0.4);\n    padding: 1px 4px;\n    border-radius: 5px;\n    cursor: pointer;\n    transition: background-color 0.2s ease;\n    font-weight: bold;\n    box-shadow: 0 0 5px rgba(255, 215, 0, 0.7);\n}"},{name:"Brand Blue",css:".atable-highlight {\n    color: #4a90e2;\n    background-color: rgba(74, 144, 226, 0.1);\n    padding: 1px 4px;\n    border-radius: 5px;\n    cursor: pointer;\n    font-weight: bold;\n}"},{name:"Neon Cyan",css:".atable-highlight {\n    color: #00ffff;\n    background-color: rgba(0, 255, 255, 0.1);\n    padding: 1px 4px;\n    border-radius: 3px;\n    border: 1px solid rgba(0, 255, 255, 0.3);\n    cursor: pointer;\n    text-shadow: 0 0 3px #00ffff;\n}"},{name:"下划线",css:".atable-highlight {\n    text-decoration: underline;\n    text-decoration-color: #4a90e2;\n    text-decoration-thickness: 2px;\n    cursor: pointer;\n    font-weight: bold;\n    background-color: transparent;\n}"}]});const x=function(){f[v]||(f[v]=structuredClone(y));const e=f[v];e.sendFormat&&!e.templates&&(console.log("[feinianyu-atable] Migrating old settings for send templates..."),e.templates=[{name:"Imported Template",content:e.sendFormat}],e.activeTemplateIndex=0,delete e.sendFormat,_());for(const t of Object.keys(y))Object.hasOwn(e,t)||(e[t]=y[t]);return e}();let I=[];const{saveSettingsDebounced:T}=globalThis.SillyTavern.getContext();function w(e,t){e.empty(),t.forEach(((t,n)=>{const a=`\n            <div class="tag-item">\n                <span>${t}</span>\n                ${0===n?"":`<span class="delete-tag" data-index="${n}" title="Delete pattern">✖</span>`}\n            </div>\n        `;e.append(a)}))}function S(e,t,n,a){const i=$(e),l=$(t),o=$(n),s=()=>{const e=i.val().trim();e&&!a.includes(e)&&(a.push(e),T(),w(o,a),i.val(""))};l.on("click",s),i.on("keypress",(function(e){13===e.which&&s()})),o.on("click",".delete-tag",(function(){const e=parseInt($(this).data("index"),10);0!==e&&(a.splice(e,1),T(),w(o,a))}))}function k(){const e=x.highlightStyles[x.activeHighlightStyleIndex];e&&e.css?$("#feinianyu_atable_dynamic_styles").text(e.css):$("#feinianyu_atable_dynamic_styles").text("")}function A(){const e=$("#feinianyu_atable_highlight_style_list_container");e.empty(),x.highlightStyles.forEach(((t,n)=>{const a=`\n            <div class="atable-template-item flex-container ${n===x.activeHighlightStyleIndex?"atable-template-item-selected":""}" data-index="${n}">\n                <div class="atable-template-inputs">\n                    <input type="text" class="text_pole atable-style-name" placeholder="Style Name" value="${t.name}">\n                    <textarea class="text_pole atable-template-content atable-style-css" rows="5" placeholder="CSS Content">${t.css}</textarea>\n                </div>\n                <div class="menu_button menu_button_icon atable-delete-style" title="Delete this style">\n                    <i class="fa-solid fa-trash-can"></i>\n                </div>\n            </div>\n        `;e.append(a)}))}function P(){const e=$("#feinianyu_atable_template_list_container");e.empty(),x.templates.forEach(((t,n)=>{const a=0===n,i=a?"readonly":"",l=a?"disabled":"",o=a?"Default template cannot be deleted":"Delete this template",s=`\n            <div class="atable-template-item flex-container ${n===x.activeTemplateIndex?"atable-template-item-selected":""}" data-index="${n}">\n                <div class="atable-template-inputs">\n                    <input type="text" class="text_pole atable-template-name" placeholder="Template Name" value="${t.name}" ${i}>\n                    <textarea class="text_pole atable-template-content" rows="3" placeholder="Template Content" ${i}>${t.content}</textarea>\n                </div>\n                <div class="menu_button menu_button_icon atable-delete-template" title="${o}" ${l}>\n                    <i class="fa-solid fa-trash-can"></i>\n                </div>\n            </div>\n        `;e.append(s)}))}function C(){const e=$("#feinianyu_atable_prompt_template_list_container");e.empty(),x.promptTemplates.forEach(((t,n)=>{const a=0===n,i=a?"readonly":"",l=a?"disabled":"",o=a?"Default prompt cannot be deleted":"Delete this prompt",s=`\n            <div class="atable-template-item flex-container ${n===x.activePromptTemplateIndex?"atable-template-item-selected":""}" data-index="${n}">\n                <div class="atable-template-inputs">\n                    <input type="text" class="text_pole atable-prompt-template-name" placeholder="Template Name" value="${t.name}" ${i}>\n                    <textarea class="text_pole atable-template-content" rows="3" placeholder="Template Content" ${i}>${t.content}</textarea>\n                </div>\n                <div class="menu_button menu_button_icon atable-delete-prompt-template" title="${o}" ${l}>\n                    <i class="fa-solid fa-trash-can"></i>\n                </div>\n            </div>\n        `;e.append(s)}))}function E(){const e=x.enabled;if($("#feinianyu_atable_main_settings_container").toggleClass("disabled-content",!e),!e)return;const t=x.enableTemplateReplacement,n=x.autoInject;$("#feinianyu_atable_template_list_container, #feinianyu_atable_add_template").toggleClass("disabled-content",!t),$("#feinianyu_atable_prompt_template_list_container, #feinianyu_atable_add_prompt_template").toggleClass("disabled-content",!n)}function j(){$("#feinianyu_atable_enabled").prop("checked",x.enabled),$("#feinianyu_atable_auto_inject").prop("checked",x.autoInject),$("#feinianyu_atable_enable_template_replacement").prop("checked",x.enableTemplateReplacement),$("#feinianyu_atable_nonHighlightedWords").val(x.nonHighlightedWords),P(),C(),A(),k(),w($("#feinianyu_atable_opening_tag_patterns_container"),x.openingTagPatterns),w($("#feinianyu_atable_closing_tag_patterns_container"),x.closingTagPatterns),E(),function(){$("#feinianyu_atable_enabled").on("change",(function(){x.enabled=this.checked,T(),E()})),$("#feinianyu_atable_auto_inject").on("change",(function(){x.autoInject=this.checked,T(),E()})),$("#feinianyu_atable_enable_template_replacement").on("change",(function(){x.enableTemplateReplacement=this.checked,T(),E()})),$("#feinianyu_atable_nonHighlightedWords").on("input",(function(){x.nonHighlightedWords=this.value,T()})),S("#feinianyu_atable_new_opening_tag_pattern","#feinianyu_atable_add_opening_tag_pattern","#feinianyu_atable_opening_tag_patterns_container",x.openingTagPatterns),S("#feinianyu_atable_new_closing_tag_pattern","#feinianyu_atable_add_closing_tag_pattern","#feinianyu_atable_closing_tag_patterns_container",x.closingTagPatterns),$("#feinianyu_atable_add_template").on("click",(function(){x.templates.push({name:"New Template",content:""}),x.activeTemplateIndex=x.templates.length-1,T(),P()}));const e=$("#feinianyu_atable_template_list_container");e.on("click",".atable-delete-template",(function(e){e.stopPropagation();const t=parseInt($(this).closest(".atable-template-item").data("index"),10);0!==t&&(x.templates.splice(t,1),x.activeTemplateIndex>=x.templates.length&&(x.activeTemplateIndex=x.templates.length-1),T(),P())})),e.on("click",".atable-template-item",(function(){const e=parseInt($(this).data("index"),10);x.activeTemplateIndex!==e&&(x.activeTemplateIndex=e,T(),P())})),e.on("input",".atable-template-name",(function(){const e=parseInt($(this).closest(".atable-template-item").data("index"),10);0!==e&&(x.templates[e].name=$(this).val(),T())})),e.on("input",".atable-template-content",(function(){const e=parseInt($(this).closest(".atable-template-item").data("index"),10);0!==e&&(x.templates[e].content=$(this).val(),T())})),$("#feinianyu_atable_add_prompt_template").on("click",(function(){x.promptTemplates.push({name:"New Prompt",content:""}),x.activePromptTemplateIndex=x.promptTemplates.length-1,T(),C()}));const t=$("#feinianyu_atable_prompt_template_list_container");t.on("click",".atable-delete-prompt-template",(function(e){e.stopPropagation();const t=parseInt($(this).closest(".atable-template-item").data("index"),10);0!==t&&(x.promptTemplates.splice(t,1),x.activePromptTemplateIndex>=x.promptTemplates.length&&(x.activePromptTemplateIndex=x.promptTemplates.length-1),T(),C())})),t.on("click",".atable-template-item",(function(){const e=parseInt($(this).data("index"),10);x.activePromptTemplateIndex!==e&&(x.activePromptTemplateIndex=e,T(),C())})),t.on("input",".atable-prompt-template-name",(function(){const e=parseInt($(this).closest(".atable-template-item").data("index"),10);0!==e&&(x.promptTemplates[e].name=$(this).val(),T())})),t.on("input",".atable-template-content",(function(){const e=parseInt($(this).closest(".atable-template-item").data("index"),10);0!==e&&(x.promptTemplates[e].content=$(this).val(),T())})),$("#feinianyu_atable_add_highlight_style").on("click",(function(){x.highlightStyles.push({name:"New Style",css:".atable-highlight {\n\n}"}),x.activeHighlightStyleIndex=x.highlightStyles.length-1,T(),A(),k()}));const n=$("#feinianyu_atable_highlight_style_list_container");n.on("click",".atable-delete-style",(function(e){e.stopPropagation();const t=parseInt($(this).closest(".atable-template-item").data("index"),10);x.highlightStyles.splice(t,1),x.activeHighlightStyleIndex>=x.highlightStyles.length&&(x.activeHighlightStyleIndex=x.highlightStyles.length-1),T(),A(),k()})),n.on("click",".atable-template-item",(function(){const e=parseInt($(this).data("index"),10);x.activeHighlightStyleIndex!==e&&(x.activeHighlightStyleIndex=e,T(),A(),k())})),n.on("input",".atable-style-name",(function(){const e=parseInt($(this).closest(".atable-template-item").data("index"),10);x.highlightStyles[e].name=$(this).val(),T()})),n.on("input",".atable-style-css",(function(){const e=parseInt($(this).closest(".atable-template-item").data("index"),10);x.highlightStyles[e].css=$(this).val(),T(),e===x.activeHighlightStyleIndex&&k()}))}()}const H=e=>{if(x.enabled&&(1===e.nodeType&&e.matches(".mes")&&!e.dataset.atableProcessed)){const t=e.querySelector(".mes_text");if(t){let e=t.innerHTML;const n=/\[at-list\](.*?)\[\/at-list\]/g,a=n.exec(e);if(a){const t=(a[1]||"").split(",").map((e=>e.trim())).filter((e=>e.length>0));I=t,console.log("[feinianyu-atable] Updated character list:",t),e=e.replace(n,"")}if(!x.openingTagPatterns?.length||!x.closingTagPatterns?.length)return;const i=x.openingTagPatterns.join("|"),l=x.closingTagPatterns.join("|"),o=new RegExp(`\\[(${i})([^\\]]*?)\\](.*?)(\\[(${l})\\])`,"gis"),s=x.nonHighlightedWords.split(",").map((e=>e.trim())),r=e.replace(o,((e,t,n,a,i)=>{const l=(e=>{const t={},n=/(\w+)=(?:"([^"]+)"|<q>"([^"]+)"<\/q>)/g;let a;for(;null!==(a=n.exec(e));)t[a[1]]=a[2]||a[3];return t})(n);return l.name&&!s.includes(a)?`<span class="atable-highlight" data-character-name="${l.name}">${a}</span>`:a}));t.innerHTML!==r&&(t.innerHTML=r)}e.dataset.atableProcessed="true"}};let M;const O=()=>{const e=document.getElementById("chat");e&&(M=new MutationObserver((e=>{const t=new Set;for(const n of e)if("childList"===n.type&&(n.addedNodes.forEach((e=>{if(1===e.nodeType)if(e.matches(".mes"))t.add(e);else{const n=e.closest(".mes");n&&t.add(n)}})),n.target&&n.target.closest)){const e=n.target.closest(".mes");e&&t.add(e)}t.forEach((e=>{delete e.dataset.atableProcessed,H(e)}))})),M.observe(e,{childList:!0,subtree:!0}),e.querySelectorAll(".mes").forEach((e=>H(e))),console.log("[feinianyu-atable] MutationObserver is now watching #chat."))};let N,R;const{setExtensionPrompt:L}=globalThis.SillyTavern.getContext();function D(){console.log("[feinianyu-atable] Starting services..."),O(),async function(){let e,t,n;try{e=(await import("/scripts/autocomplete/AutoComplete.js")).AutoComplete;const a=await import("/scripts/autocomplete/AutoCompleteOption.js");t=a.AutoCompleteOption;const i=await import("/scripts/autocomplete/AutoCompleteNameResult.js");n=i.AutoCompleteNameResult}catch(e){return console.error("[feinianyu-atable] Failed to load AutoComplete modules!",e),void toastr.error("Feinianyu-Atable failed to load AutoComplete functionality.")}const a=document.getElementById("send_textarea");N=new e(a,(()=>{if(!x.enabled||0===I.length)return!1;const e=a.value.substring(0,a.selectionStart),t=e.match(/@([^\s@]*)$/);if(t){const n=e.lastIndexOf(t[0]);return 0===n||/\s/.test(e.charAt(n-1))}return!1}),(async(e,a)=>{const i=e.substring(0,a),l=i.match(/@([^\s@]*)$/);if(!l)return null;const o=l[1],s=i.lastIndexOf(l[0]),r=(o?I.filter((e=>e.startsWith(o))):I).map((e=>new t(e,"@","")));return new n(o,s+1,r,{canBeQuoted:!1})}),!1),N.select=async function(){if(this.isReplaceable&&null!==this.selectedItem.value){const e=this.selectedItem.value,t=this.textarea.value,n=this.effectiveParserResult.start-1,a=n+this.effectiveParserResult.name.length+1;this.textarea.value=`${t.slice(0,n)}@${e} ${t.slice(a)}`;const i=n+1+e.length+1;this.textarea.selectionStart=i,this.textarea.selectionEnd=i,this.textarea.dispatchEvent(new Event("input",{bubbles:!0})),this.hide()}},$("#chat").on("click.atable",".atable-highlight",(function(){if(!x.enabled)return;const e=$(this).data("character-name");if(e){const t=$("#send_textarea");t.val(t.val()+"@"+e+" "),t.focus()}})),R=function(e){if(e.target.closest("#send_but")){if(!x.enabled||!x.enableTemplateReplacement)return;const e=$("#send_textarea");let t=e.val();if(!t.includes("@"))return;console.log("[feinianyu-atable] Intercepting send for @ message.");const n=x.templates[x.activeTemplateIndex];if(!n||!n.content||""===n.content.trim())return void toastr.error("Active @template is empty. Sending message as is.");if(!n.content.includes("{{name}}")&&!n.content.includes("{{content}}"))return toastr.error("Active @template is invalid (missing {{name}} or {{content}}). Sending message as is."),void console.log("[feinianyu-atable] Template validation failed: placeholders missing.");try{let a="";const i=/@(\S+)\s*([^@]*)/g;let l,o=0;for(;null!==(l=i.exec(t));){a+=t.substring(o,l.index);const e=l[1],i=l[2].trim();a+=n.content.replace("{{name}}",e).replace("{{content}}",i),o=l.index+l[0].length}o<t.length&&(a+=t.substring(o)),e.val(a)}catch(e){toastr.error("Failed to apply @template. Sending message as is."),console.error("[feinianyu-atable] Error applying template:",e)}}},document.addEventListener("mousedown",R,!0)}()}function W(){console.log("[feinianyu-atable] Stopping services..."),M&&(M.disconnect(),M=null,console.log("[feinianyu-atable] MutationObserver stopped.")),N&&(N.hide(),N=null),$("#chat").off("click.atable"),R&&(document.removeEventListener("mousedown",R,!0),R=null),console.log("[feinianyu-atable] Input handlers stopped."),L(v,"",0),console.log("[feinianyu-atable] Cleared extension prompt.")}globalThis.feinianyuAtableInterceptor=(e,t,n,a)=>{const i=function(){const e=x.promptTemplates[x.activePromptTemplateIndex];return x.enabled&&x.autoInject&&e&&""!==e.content.trim()?e.content:null}();if(i){const e=2;console.log("[feinianyu-atable] Auto-injecting prompt."),L(v,i,e)}},jQuery((async()=>{await new Promise((e=>{const t=setInterval((()=>{$("#chat").length&&$("#extensions_settings").length&&$("#send_textarea").length&&(clearInterval(t),e())}),100)})),console.log("[feinianyu-atable] Core UI ready. Initializing extension..."),$("#extensions_settings").append('<style>.collapsible-help{margin-top:8px;margin-bottom:5px;width:100%}.collapsible-help summary{display:flex;align-items:center;padding:2px 0;cursor:pointer;outline:0;-webkit-tap-highlight-color:transparent}.collapsible-help summary::-webkit-details-marker{display:none}.collapsible-help summary{list-style:none}.summary-indicator{width:0;height:0;border-left:5px solid transparent;border-right:5px solid transparent;border-top:5px solid currentColor;margin-right:8px;opacity:.7;transform-origin:center;transition:transform .2s ease-in-out}.collapsible-help details[open]>summary .summary-indicator{transform:rotate(180deg)}.summary-title{color:var(--text-secondary-color,#b9b9b9);font-size:.9em;transition:color .2s ease}.collapsible-help summary:hover .summary-title{color:var(--link-color,#8ab4f8)}.details-content{padding-left:18px;padding-bottom:5px}.details-content p{font-size:.9em;color:var(--text-secondary-color,#b9b9b9);line-height:1.6;margin:5px 0 0 0}.details-content p b{color:var(--text-color,#e1e1e1)}.disabled-content{opacity:.6;pointer-events:none}</style> <div class="feinianyu-atable-settings"> <div class="inline-drawer"> <div class="inline-drawer-toggle inline-drawer-header"> <b>Atable 插件设置</b> <div class="inline-drawer-icon fa-solid fa-circle-chevron-down"></div> </div> <div class="inline-drawer-content"> <div class="setting_item"> <label for="feinianyu_atable_enabled" class="flex-container"> <input type="checkbox" id="feinianyu_atable_enabled"> <span>启用 Atable 插件</span> </label> </div> <hr> <div id="feinianyu_atable_main_settings_container"> <div class="form_group_boxtitle">输入增强</div> <div class="setting_item"> <label for="feinianyu_atable_enable_template_replacement" class="flex-container"> <input type="checkbox" id="feinianyu_atable_enable_template_replacement"> <span>启用输入增强</span> </label> <div class="collapsible-help"> <details> <summary> <div class="summary-indicator"></div> <span class="summary-title">这是什么？</span> </summary> <div class="details-content"> <p>启用后，在输入框中键入的 "@角色名 内容" 将在发送时被替换为下方选定的模板格式。</p> <p>如需手动注入，请关闭此选项。</p> </div> </details> </div> </div> <div class="form-group"> <label>发送模板管理 (点击选择激活的模板)</label> <div id="feinianyu_atable_template_list_container"> </div> <div id="feinianyu_atable_add_template" class="menu_button menu_button_icon"> <i class="fa-solid fa-plus"></i> <span>添加新模板</span> </div> </div> <hr> <div class="form_group_boxtitle">聊天显示与渲染</div> <div class="form-group"> <label for="feinianyu_atable_nonHighlightedWords">不高亮词汇</label> <p class="description">在这里输入不希望被高亮的词语，用英文逗号分隔。例如：你,我,他,她</p> <input type="text" id="feinianyu_atable_nonHighlightedWords" class="text_pole"> </div> <div class="form-group"> <label>高亮样式管理 (点击选择激活的样式)</label> <div id="feinianyu_atable_highlight_style_list_container"> </div> <div id="feinianyu_atable_add_highlight_style" class="menu_button menu_button_icon"> <i class="fa-solid fa-plus"></i> <span>添加新样式</span> </div> </div> <hr> <div class="form_group_boxtitle">AI 提示词</div> <div class="setting_item"> <label for="feinianyu_atable_auto_inject" class="flex-container"> <input type="checkbox" id="feinianyu_atable_auto_inject"> <span>自动注入提示词</span> </label> <div class="collapsible-help"> <details> <summary> <div class="summary-indicator"></div> <span class="summary-title">这是什么？如何使用？</span> </summary> <div class="details-content"> <p>启用后，每次发送消息都会自动在最终提示词中加入下方选定的指令，以引导AI返回特定格式。</p> <p><b>例如：</b>你可以创建一个提示词，要求AI在回复中用特定标签包裹角色名，这样插件才能识别并高亮它们。</p> <p>选择一个下方激活的模板，它将在生成回复时被自动添加到你的主输入内容的末尾。</p> </div> </details> </div> </div> <div class="form-group"> <label>提示词模板管理 (点击选择激活的模板)</label> <div id="feinianyu_atable_prompt_template_list_container"> </div> <div class="menu_button menu_button_icon" id="feinianyu_atable_add_prompt_template"> <i class="fa-solid fa-plus"></i> <span>添加新提示词</span> </div> </div> <hr> <div class="form_group_boxtitle">高级：自定义渲染规则</div> <div class="collapsible-help"> <details> <summary> <div class="summary-indicator"></div> <span class="summary-title">这是什么？</span> </summary> <div class="details-content"> <p>这里定义了插件如何从AI的回复中识别出需要高亮的内容。通常不需要修改。如果AI总是返回无法被解析的标签，可以在这里加入。</p> <p>例如：AI 总是返回 [at-tah name = "xxx"] ... [/at-tag]</p> <p>那么可以将 at-tah 加入到 开始标签匹配模式 中。 </p></div> </details> </div> <div class="form-group"> <label>开始标签匹配模式</label> <div id="feinianyu_atable_opening_tag_patterns_container" class="tag-container"> </div> <div class="add-tag-container"> <input type="text" id="feinianyu_atable_new_opening_tag_pattern" class="text_pole" placeholder="输入模式后按回车或点击添加"> <div id="feinianyu_atable_add_opening_tag_pattern" class="menu_button menu_button_icon"> <i class="fa-solid fa-plus"></i> <span>添加</span> </div> </div> </div> <div class="form-group"> <label>结束标签匹配模式</label> <div id="feinianyu_atable_closing_tag_patterns_container" class="tag-container"> </div> <div class="add-tag-container"> <input type="text" id="feinianyu_atable_new_closing_tag_pattern" class="text_pole" placeholder="输入模式后按回车或点击添加"> <div id="feinianyu_atable_add_closing_tag_pattern" class="menu_button menu_button_icon"> <i class="fa-solid fa-plus"></i> <span>添加</span> </div> </div> </div> </div> </div> </div> </div> '),$("#feinianyu_atable_dynamic_styles").length||$("head").append('<style id="feinianyu_atable_dynamic_styles"></style>'),j(),x.enabled&&D(),$("#feinianyu_atable_enabled").on("change",(function(){this.checked?D():W()})),console.log("[feinianyu-atable] Extension fully initialized and interceptor is globally available.")}))})();