(()=>{"use strict";var e={208:(e,t,n)=>{n.d(t,{A:()=>s});var a=n(601),i=n.n(a),l=n(314),o=n.n(l)()(i());o.push([e.id,"/* 基础高亮样式 */\n.atable-highlight {\n    background-color: rgba(255, 215, 0, 0.4); /* 金色背景，带透明度 */\n    padding: 1px 4px;\n    border-radius: 5px;\n    cursor: pointer;\n    transition: background-color 0.2s ease;\n    font-weight: bold;\n}\n\n.atable-highlight:hover {\n    background-color: rgba(255, 215, 0, 0.6); /* 鼠标悬停时加深背景色 */\n}\n\n/* 模板列表项样式 */\n.atable-template-content {\n    max-height: 150px; /* 设置一个最大高度 */\n    overflow-y: auto;  /* 当内容超出时，显示垂直滚动条 */\n    resize: vertical;  /* 允许用户垂直调整大小 */\n}\n\n.atable-template-item {\n    margin-bottom: 8px;\n    align-items: stretch;\n    border: 1px solid var(--border-color, #cccccc);\n    border-radius: 5px;\n    padding: 8px;\n    transition: border-color 0.2s, background-color 0.2s;\n    cursor: pointer;\n}\n\n.atable-template-inputs {\n    flex: 1;\n    display: flex;\n    flex-direction: column;\n    margin-right: 8px;\n}\n\n.atable-template-name {\n    margin-bottom: 5px;\n    font-weight: bold;\n}\n\n.atable-delete-template {\n    align-self: center;\n}\n\n/* 模板选中时的高亮样式 */\n.atable-template-item-selected {\n    border-color: var(--link-color, #4a90e2);\n    background-color: rgba(var(--link-color-rgb, 74, 144, 226), 0.1);\n}\n\n/* 用于禁用UI区域的样式 */\n.disabled-section {\n    opacity: 0.6;\n    pointer-events: none;\n}\n\n/* Tag container styles */\n.tag-container {\n    display: flex;\n    flex-wrap: wrap;\n    gap: 5px;\n    margin-top: 5px;\n    margin-bottom: 10px;\n}\n\n.tag-item {\n    background-color: var(--background-color-secondary);\n    border: 1px solid var(--border-color);\n    border-radius: 5px;\n    padding: 5px 10px;\n    display: flex;\n    align-items: center;\n    gap: 8px;\n}\n\n.tag-item .delete-tag {\n    cursor: pointer;\n    font-weight: bold;\n    color: var(--text-color-secondary);\n}\n\n.tag-item .delete-tag:hover {\n    color: var(--text-color);\n}\n\n.add-tag-container {\n    display: flex;\n    gap: 10px;\n    align-items: center;\n}\n\n.add-tag-container .text_pole {\n    flex-grow: 1;\n}\n\n.atable-style-row-1 {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    margin-bottom: 8px;\n}\n\n.atable-style-row-1 .atable-style-name {\n    flex-grow: 1;\n    margin-right: 10px;\n}\n\n.atable-style-preview-wrapper {\n    flex-shrink: 0;\n    margin-right: 10px;\n}\n\n.atable-highlight-preview {\n    padding: 2px 5px;\n    border-radius: 3px;\n    white-space: nowrap;\n}\n\n.atable-style-row-2 .collapsible-help {\n    margin-top: 0;\n}\n",""]);const s=o},314:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var n="",a=void 0!==t[5];return t[4]&&(n+="@supports (".concat(t[4],") {")),t[2]&&(n+="@media ".concat(t[2]," {")),a&&(n+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),n+=e(t),a&&(n+="}"),t[2]&&(n+="}"),t[4]&&(n+="}"),n})).join("")},t.i=function(e,n,a,i,l){"string"==typeof e&&(e=[[null,e,void 0]]);var o={};if(a)for(var s=0;s<this.length;s++){var r=this[s][0];null!=r&&(o[r]=!0)}for(var c=0;c<e.length;c++){var p=[].concat(e[c]);a&&o[p[0]]||(void 0!==l&&(void 0===p[5]||(p[1]="@layer".concat(p[5].length>0?" ".concat(p[5]):""," {").concat(p[1],"}")),p[5]=l),n&&(p[2]?(p[1]="@media ".concat(p[2]," {").concat(p[1],"}"),p[2]=n):p[2]=n),i&&(p[4]?(p[1]="@supports (".concat(p[4],") {").concat(p[1],"}"),p[4]=i):p[4]="".concat(i)),t.push(p))}},t}},601:e=>{e.exports=function(e){return e[1]}},72:e=>{var t=[];function n(e){for(var n=-1,a=0;a<t.length;a++)if(t[a].identifier===e){n=a;break}return n}function a(e,a){for(var l={},o=[],s=0;s<e.length;s++){var r=e[s],c=a.base?r[0]+a.base:r[0],p=l[c]||0,d="".concat(c," ").concat(p);l[c]=p+1;var m=n(d),u={css:r[1],media:r[2],sourceMap:r[3],supports:r[4],layer:r[5]};if(-1!==m)t[m].references++,t[m].updater(u);else{var g=i(u,a);a.byIndex=s,t.splice(s,0,{identifier:d,updater:g,references:1})}o.push(d)}return o}function i(e,t){var n=t.domAPI(t);n.update(e);return function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;n.update(e=t)}else n.remove()}}e.exports=function(e,i){var l=a(e=e||[],i=i||{});return function(e){e=e||[];for(var o=0;o<l.length;o++){var s=n(l[o]);t[s].references--}for(var r=a(e,i),c=0;c<l.length;c++){var p=n(l[c]);0===t[p].references&&(t[p].updater(),t.splice(p,1))}l=r}}},659:e=>{var t={};e.exports=function(e,n){var a=function(e){if(void 0===t[e]){var n=document.querySelector(e);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(e){n=null}t[e]=n}return t[e]}(e);if(!a)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");a.appendChild(n)}},540:e=>{e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},56:(e,t,n)=>{e.exports=function(e){var t=n.nc;t&&e.setAttribute("nonce",t)}},825:e=>{e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=e.insertStyleElement(e);return{update:function(n){!function(e,t,n){var a="";n.supports&&(a+="@supports (".concat(n.supports,") {")),n.media&&(a+="@media ".concat(n.media," {"));var i=void 0!==n.layer;i&&(a+="@layer".concat(n.layer.length>0?" ".concat(n.layer):""," {")),a+=n.css,i&&(a+="}"),n.media&&(a+="}"),n.supports&&(a+="}");var l=n.sourceMap;l&&"undefined"!=typeof btoa&&(a+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(l))))," */")),t.styleTagTransform(a,e,t.options)}(t,e,n)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}},113:e=>{e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}}},t={};function n(a){var i=t[a];if(void 0!==i)return i.exports;var l=t[a]={id:a,exports:{}};return e[a](l,l.exports,n),l.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var a in t)n.o(t,a)&&!n.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.nc=void 0;var a=n(72),i=n.n(a),l=n(825),o=n.n(l),s=n(659),r=n.n(s),c=n(56),p=n.n(c),d=n(540),m=n.n(d),u=n(113),g=n.n(u),b=n(208),h={};h.styleTagTransform=g(),h.setAttributes=p(),h.insert=r().bind(null,"head"),h.domAPI=o(),h.insertStyleElement=m();i()(b.A,h);b.A&&b.A.locals&&b.A.locals;let f,v,_;function y(e,...t){const n=(new Date).toLocaleTimeString(),a=t.map((e=>{if("object"==typeof e&&null!==e)try{return JSON.stringify(e)}catch(e){return"Unserializable Object"}return e})).join(" "),i=`[${n}] [${e.toUpperCase()}]: ${a}\n`;"function"==typeof console[e]?console[e](...t):console.log(...t),f&&(f.value+=i,f.scrollTop=f.scrollHeight)}async function x(){if(f&&navigator.clipboard)try{await navigator.clipboard.writeText(f.value);const e=v.querySelector("span").textContent;v.querySelector("span").textContent="已复制!",setTimeout((()=>{v.querySelector("span").textContent=e}),2e3)}catch(e){I.error("无法复制日志:",e)}}function w(){f&&(f.value="")}const I={init:function(){f=document.getElementById("atable-log-textarea"),v=document.getElementById("atable-copy-log"),_=document.getElementById("atable-clear-log"),v&&v.addEventListener("click",x),_&&_.addEventListener("click",w)},log:(...e)=>y("log",...e),info:(...e)=>y("info",...e),warn:(...e)=>y("warn",...e),error:(...e)=>y("error",...e)},T=I,{extensionSettings:S,saveSettingsDebounced:k}=globalThis.SillyTavern.getContext(),A="feinianyu-atable",C=Object.freeze({enabled:!0,nonHighlightedWords:"你,我,他,她",openingTagPatterns:["at-tag"],closingTagPatterns:["/at-tag"],autoInject:!0,enableTemplateReplacement:!0,activeTemplateIndex:0,templates:[{name:"默认模板",content:"(我对{{name}}说) {{content}}"}],activePromptTemplateIndex:0,promptTemplates:[{name:"默认提示词",content:'\n# 系统指令：角色标记协议\n为了增强用户互动，你必须在回复中遵守以下标记协议。\n本协议使用两种特殊的BBCode标签：[at-tag] 用于行内角色识别，[at-list] 用于管理场景的角色名单。\n\n- 此协议仅针对可互动的生物有效，非生物不在此列，绝不高亮非生物物品。\n\n## 1. 名单标签：[at-list]\n\n目的：提供一个场景中当前存在且可互动的所有角色的明确的、机器可读的列表。此列表用于填充一个用户界面元素。\n\n语法：`[at-list]角色A,角色B,角色C[/at-list]`\n\n规则：\n- 位置：此标签必须放置在整个回复的绝对末尾。其后不应有任何内容。\n- 内容： 一个逗号分隔的角色名称列表。请勿在逗号周围包含空格。\n- 权威性：此列表代表当前回复之后场景的最终状态。如果在你的回复中有一个角色进入场景，其名称应当被添加到此列表中。如果在你的回复中有一个角色离开场景，其名称应当从此列表中移除。\n- 元数据：此标签仅供系统使用，将对用户隐藏。\n\n## 2. 行内标签：[at-tag]\n\n目的： 将叙述或对话中任何提及的角色，明确链接回其在 [at-list] 中的官方名称。\n\n语法：`[at-tag name="官方名称"]要显示的文本[/at-tag]`\n\n规则：\n- name 属性： name 属性的值 必须与你此回复最终 [at-list] 标签中存在的某个角色名称完全匹配 。\n- 要显示的文本： 这是将实际显示给用户的文本。\n-  注意对于代词（你，我，她），不使用tag标记\n- 任何第一次被描述的人物，都需要被标记，标记的位置在第一次提到他的位置。\n\n- 用法：你应该为每一次提及角色都使用此标签，以确保系统最大程度的清晰度。\n\n## 示例工作流程\n\n先前场景状态：场景中存在的角色是 \'Elara\' 和 \'Jax\'。\n\n用户的消息： “Elara 拔出了她的剑。突然，一个黑影从椽子上跳下来，悄无声息地落在 Jax 后面。”\n\n你的回复生成：\n\n1.  叙述动作： 描述这个黑影。我们叫他 \'Silas\'。\n2.  标记已有角色：当提到 Elara 或 Jax 时，标记他们。\n3.  标记新角色：用他的新官方名称 \'Silas\' 标记“黑影”。\n4.  更新名单：场景现在包含 Elara、Jax 和 Silas。\n5.  构建最终输出：\n\n你的最终原始输出类似如下所示：\n\n[at-tag name="Elara"]Elara[/at-tag] 的剑“噌”地出鞘，抛光的剑身捕捉到了昏暗的光线。在 [at-tag name="Jax"]Jax[/at-tag] 还来不及反应之前，一个 [at-tag name="Silas"]黑影[/at-tag] 从天花板上跳下，落地时优雅得像只猫。这个 [at-tag name="Silas"]新来者[/at-tag] 缓缓站起，他手中闪烁着两把看起来很邪恶的匕首。你是谁？” 她喝问道，她的声音尽管惊讶却依旧平稳。\n[at-list]Elara,Jax,Silas[/at-list]\n\n通过遵守此协议，您将能实现丰富的、互动的体验。必须严格遵守'}],activeHighlightStyleIndex:0,highlightStyles:[{name:"霓虹青",css:".atable-highlight {\n    color: #00ffff;\n    background-color: rgba(0, 255, 255, 0.1);\n    padding: 1px 4px;\n    border-radius: 3px;\n    border: 1px solid rgba(0, 255, 255, 0.3);\n    cursor: pointer;\n    text-shadow: 0 0 3px #00ffff;\n}"},{name:"鎏金",css:".atable-highlight {\n    background-color: rgba(255, 215, 0, 0.4);\n    padding: 1px 4px;\n    border-radius: 5px;\n    cursor: pointer;\n    transition: background-color 0.2s ease;\n    font-weight: bold;\n    box-shadow: 0 0 5px rgba(255, 215, 0, 0.7);\n}"},{name:"静谧蓝",css:".atable-highlight {\n    color: #4a90e2;\n    background-color: rgba(74, 144, 226, 0.1);\n    padding: 1px 4px;\n    border-radius: 5px;\n    cursor: pointer;\n    font-weight: bold;\n}"},{name:"下划线",css:".atable-highlight {\n    text-decoration: underline;\n    text-decoration-color: #4a90e2;\n    text-decoration-thickness: 2px;\n    cursor: pointer;\n    font-weight: bold;\n    background-color: transparent;\n}"}]});const E=function(){S[A]||(T.log("Initializing default settings for the first time."),S[A]=structuredClone(C));const e=S[A];e.sendFormat&&!e.templates&&(T.log("Migrating old settings for send templates..."),e.templates=[{name:"Imported Template",content:e.sendFormat}],e.activeTemplateIndex=0,delete e.sendFormat,k());for(const t of Object.keys(C))Object.hasOwn(e,t)||(e[t]=C[t]);return e}();let P=[];const{saveSettingsDebounced:j}=globalThis.SillyTavern.getContext();function H(e,t){e.empty(),t.forEach(((t,n)=>{const a=`\n            <div class="tag-item">\n                <span>${t}</span>\n                ${0===n?"":`<span class="delete-tag" data-index="${n}" title="Delete pattern">✖</span>`}\n            </div>\n        `;e.append(a)}))}function R(e,t,n,a){const i=$(e),l=$(t),o=$(n),s=()=>{const e=i.val().trim();e&&!a.includes(e)&&(a.push(e),j(),H(o,a),i.val(""))};l.on("click",s),i.on("keypress",(function(e){13===e.which&&s()})),o.on("click",".delete-tag",(function(){const e=parseInt($(this).data("index"),10);0!==e&&(a.splice(e,1),j(),H(o,a))}))}function O(){const e=E.highlightStyles[E.activeHighlightStyleIndex];e&&e.css?$("#feinianyu_atable_dynamic_styles").text(e.css):$("#feinianyu_atable_dynamic_styles").text("")}function M(){const e=$("#feinianyu_atable_highlight_style_list_container"),t=$("#feinianyu_atable_preview_styles");e.empty(),t.empty(),E.highlightStyles.forEach(((n,a)=>{const i=a===E.activeHighlightStyleIndex?"atable-template-item-selected":"",l=`atable-preview-instance-${a}`,o=n.css.replace(/\.atable-highlight/g,`.${l}`);t.append(`<style>${o}</style>`);const s=`\n            <div class="atable-template-item ${i}" data-index="${a}">\n                <div class="atable-style-row-1">\n                    <input type="text" class="text_pole atable-style-name" placeholder="Style Name" value="${n.name}">\n                    <div class="atable-style-preview-wrapper">\n                        <span class="${l} atable-highlight-preview">@预览效果</span>\n                    </div>\n                    <div class="menu_button menu_button_icon atable-delete-style" title="Delete this style">\n                        <i class="fa-solid fa-trash-can"></i>\n                    </div>\n                </div>\n                <div class="atable-style-row-2">\n                    <details class="collapsible-help">\n                        <summary>\n                            <div class="summary-indicator"></div>\n                            <span class="summary-title">CSS Code</span>\n                        </summary>\n                        <div class="details-content">\n                            <textarea class="text_pole atable-template-content atable-style-css" rows="5" placeholder="CSS Content">${n.css}</textarea>\n                        </div>\n                    </details>\n                </div>\n            </div>\n        `;e.append(s)}))}function z(){const e=$("#feinianyu_atable_template_list_container");e.empty(),E.templates.forEach(((t,n)=>{const a=0===n,i=a?"readonly":"",l=a?"disabled":"",o=a?"Default template cannot be deleted":"Delete this template",s=`\n            <div class="atable-template-item flex-container ${n===E.activeTemplateIndex?"atable-template-item-selected":""}" data-index="${n}">\n                <div class="atable-template-inputs">\n                    <input type="text" class="text_pole atable-template-name" placeholder="Template Name" value="${t.name}" ${i}>\n                    <textarea class="text_pole atable-template-content" rows="3" placeholder="Template Content" ${i}>${t.content}</textarea>\n                </div>\n                <div class="menu_button menu_button_icon atable-delete-template" title="${o}" ${l}>\n                    <i class="fa-solid fa-trash-can"></i>\n                </div>\n            </div>\n        `;e.append(s)}))}function N(){const e=$("#feinianyu_atable_prompt_template_list_container");e.empty(),E.promptTemplates.forEach(((t,n)=>{const a=0===n,i=a?"readonly":"",l=a?"disabled":"",o=a?"Default prompt cannot be deleted":"Delete this prompt",s=`\n            <div class="atable-template-item flex-container ${n===E.activePromptTemplateIndex?"atable-template-item-selected":""}" data-index="${n}">\n                <div class="atable-template-inputs">\n                    <input type="text" class="text_pole atable-prompt-template-name" placeholder="Template Name" value="${t.name}" ${i}>\n                    <textarea class="text_pole atable-template-content" rows="3" placeholder="Template Content" ${i}>${t.content}</textarea>\n                </div>\n                <div class="menu_button menu_button_icon atable-delete-prompt-template" title="${o}" ${l}>\n                    <i class="fa-solid fa-trash-can"></i>\n                </div>\n            </div>\n        `;e.append(s)}))}function L(){const e=E.enabled;if($("#feinianyu_atable_main_settings_container").toggleClass("disabled-content",!e),!e)return;const t=E.enableTemplateReplacement,n=E.autoInject;$("#feinianyu_atable_template_list_container, #feinianyu_atable_add_template").toggleClass("disabled-content",!t),$("#feinianyu_atable_prompt_template_list_container, #feinianyu_atable_add_prompt_template").toggleClass("disabled-content",!n)}function F(){$("#feinianyu_atable_enabled").on("change",(function(){E.enabled=this.checked,j(),L()})),$("#feinianyu_atable_auto_inject").on("change",(function(){E.autoInject=this.checked,j(),L()})),$("#feinianyu_atable_enable_template_replacement").on("change",(function(){E.enableTemplateReplacement=this.checked,j(),L()})),$("#feinianyu_atable_nonHighlightedWords").on("input",(function(){E.nonHighlightedWords=this.value,j()})),R("#feinianyu_atable_new_opening_tag_pattern","#feinianyu_atable_add_opening_tag_pattern","#feinianyu_atable_opening_tag_patterns_container",E.openingTagPatterns),R("#feinianyu_atable_new_closing_tag_pattern","#feinianyu_atable_add_closing_tag_pattern","#feinianyu_atable_closing_tag_patterns_container",E.closingTagPatterns),$("#feinianyu_atable_add_template").on("click",(function(){E.templates.push({name:"New Template",content:""}),E.activeTemplateIndex=E.templates.length-1,j(),z()}));const e=$("#feinianyu_atable_template_list_container");e.on("click",".atable-delete-template",(function(e){e.stopPropagation();const t=parseInt($(this).closest(".atable-template-item").data("index"),10);0!==t&&(E.templates.splice(t,1),E.activeTemplateIndex>=E.templates.length&&(E.activeTemplateIndex=E.templates.length-1),j(),z())})),e.on("click",".atable-template-item",(function(){const e=parseInt($(this).data("index"),10);E.activeTemplateIndex!==e&&(E.activeTemplateIndex=e,j(),z())})),e.on("input",".atable-template-name",(function(){const e=parseInt($(this).closest(".atable-template-item").data("index"),10);0!==e&&(E.templates[e].name=$(this).val(),j())})),e.on("input",".atable-template-content",(function(){const e=parseInt($(this).closest(".atable-template-item").data("index"),10);0!==e&&(E.templates[e].content=$(this).val(),j())})),$("#feinianyu_atable_add_prompt_template").on("click",(function(){E.promptTemplates.push({name:"New Prompt",content:""}),E.activePromptTemplateIndex=E.promptTemplates.length-1,j(),N()}));const t=$("#feinianyu_atable_prompt_template_list_container");t.on("click",".atable-delete-prompt-template",(function(e){e.stopPropagation();const t=parseInt($(this).closest(".atable-template-item").data("index"),10);0!==t&&(E.promptTemplates.splice(t,1),E.activePromptTemplateIndex>=E.promptTemplates.length&&(E.activePromptTemplateIndex=E.promptTemplates.length-1),j(),N())})),t.on("click",".atable-template-item",(function(){const e=parseInt($(this).data("index"),10);E.activePromptTemplateIndex!==e&&(E.activePromptTemplateIndex=e,j(),N())})),t.on("input",".atable-prompt-template-name",(function(){const e=parseInt($(this).closest(".atable-template-item").data("index"),10);0!==e&&(E.promptTemplates[e].name=$(this).val(),j())})),t.on("input",".atable-template-content",(function(){const e=parseInt($(this).closest(".atable-template-item").data("index"),10);0!==e&&(E.promptTemplates[e].content=$(this).val(),j())})),$("#feinianyu_atable_add_highlight_style").on("click",(function(){E.highlightStyles.push({name:"New Style",css:".atable-highlight {\n\n}"}),E.activeHighlightStyleIndex=E.highlightStyles.length-1,j(),M(),O()}));const n=$("#feinianyu_atable_highlight_style_list_container");n.on("click",".atable-delete-style",(function(e){e.stopPropagation();const t=parseInt($(this).closest(".atable-template-item").data("index"),10);E.highlightStyles.splice(t,1),E.activeHighlightStyleIndex>=E.highlightStyles.length&&(E.activeHighlightStyleIndex=E.highlightStyles.length-1),j(),M(),O()})),n.on("click",".atable-template-item",(function(){const e=parseInt($(this).data("index"),10);E.activeHighlightStyleIndex!==e&&(E.activeHighlightStyleIndex=e,j(),M(),O())})),n.on("input",".atable-style-name",(function(){const e=parseInt($(this).closest(".atable-template-item").data("index"),10);E.highlightStyles[e].name=$(this).val(),j()})),n.on("input",".atable-style-css",(function(){const e=parseInt($(this).closest(".atable-template-item").data("index"),10);E.highlightStyles[e].css=$(this).val(),j(),e===E.activeHighlightStyleIndex&&O()}));let a,i=0;$("#feinianyu_atable_restore_defaults").on("click",(function(){i++;const e=$(this);1===i?(e.find("span").text("确认？"),e.addClass("confirm-active"),a=setTimeout((()=>{i=0,e.find("span").text("恢复默认设置"),e.removeClass("confirm-active")}),3e3)):2===i&&(clearTimeout(a),T.log("Restoring default settings..."),S[A]=structuredClone(C),k(),S[A],toastr.success("已恢复默认设置。页面将刷新。"),setTimeout((()=>{location.reload()}),1e3))}))}function B(){T.init(),$("#feinianyu_atable_enabled").prop("checked",E.enabled),$("#feinianyu_atable_auto_inject").prop("checked",E.autoInject),$("#feinianyu_atable_enable_template_replacement").prop("checked",E.enableTemplateReplacement),$("#feinianyu_atable_nonHighlightedWords").val(E.nonHighlightedWords),z(),N(),M(),O(),H($("#feinianyu_atable_opening_tag_patterns_container"),E.openingTagPatterns),H($("#feinianyu_atable_closing_tag_patterns_container"),E.closingTagPatterns),L(),F(),T.log("UI module initialized, events bound.")}const D=e=>{if(E.enabled&&(1===e.nodeType&&e.matches(".mes")&&!e.dataset.atableProcessed)){const t=e.querySelector(".mes_text");if(t){let e=t.innerHTML;const n=/\[at-list\](.*?)\[\/at-list\]/g,a=n.exec(e);if(a){const t=a[1]||"";T.log("Found at-list content:",t);const i=t.split(",").map((e=>e.trim())).filter((e=>e.length>0));P=i,T.log("Updated character list:",i),e=e.replace(n,"")}if(!E.openingTagPatterns?.length||!E.closingTagPatterns?.length)return;const i=E.openingTagPatterns.join("|"),l=E.closingTagPatterns.join("|"),o=new RegExp(`\\[(${i})([^\\]]*?)\\](.*?)(\\[(${l})\\])`,"gis"),s=E.nonHighlightedWords.split(",").map((e=>e.trim())),r=e.replace(o,((e,t,n,a,i)=>{const l=(e=>{const t={},n=/(\w+)=(?:"([^"]+)"|<q>"([^"]+)"<\/q>)/g;let a;for(;null!==(a=n.exec(e));)t[a[1]]=a[2]||a[3];return t})(n);return l.name&&!s.includes(a)?`<span class="atable-highlight" data-character-name="${l.name}">${a}</span>`:a}));t.innerHTML!==r&&(T.log("Applied at-tag highlighting to message."),t.innerHTML=r)}e.dataset.atableProcessed="true"}};let J;const W=()=>{const e=document.getElementById("chat");e?(J=new MutationObserver((e=>{const t=new Set;for(const n of e)if("childList"===n.type&&(n.addedNodes.forEach((e=>{if(1===e.nodeType)if(e.matches(".mes"))t.add(e);else{const n=e.closest(".mes");n&&t.add(n)}})),n.target&&n.target.closest)){const e=n.target.closest(".mes");e&&t.add(e)}t.forEach((e=>{delete e.dataset.atableProcessed,D(e)}))})),J.observe(e,{childList:!0,subtree:!0}),e.querySelectorAll(".mes").forEach((e=>D(e))),T.log("Successfully initialized MutationObserver on #chat.")):T.error("Initialization failed: Could not find #chat element. Chat processing will not work.")};let q,U;const{setExtensionPrompt:Q}=globalThis.SillyTavern.getContext();async function G(){T.log("Starting services..."),T.log("current setting: "),T.log(E),W(),await async function(){let e,t,n;try{e=(await import("/scripts/autocomplete/AutoComplete.js")).AutoComplete;const a=await import("/scripts/autocomplete/AutoCompleteOption.js");t=a.AutoCompleteOption;const i=await import("/scripts/autocomplete/AutoCompleteNameResult.js");n=i.AutoCompleteNameResult,T.log("Successfully loaded AutoComplete modules.")}catch(e){return T.error("Failed to load AutoComplete modules! Autocomplete will be disabled.",e),void toastr.error("Feinianyu-Atable failed to load AutoComplete functionality.")}const a=document.getElementById("send_textarea");q=new e(a,(()=>{if(!E.enabled||0===P.length)return!1;const e=a.value.substring(0,a.selectionStart),t=e.match(/@([^\s@]*)$/);if(t){const n=e.lastIndexOf(t[0]),a=0===n||/\s/.test(e.charAt(n-1));return a&&T.log("AutoComplete activation check passed."),a}return!1}),(async(e,a)=>{const i=e.substring(0,a),l=i.match(/@([^\s@]*)$/);if(!l)return null;const o=l[1];T.log("AutoComplete search term:",o);const s=i.lastIndexOf(l[0]),r=(o?P.filter((e=>e.startsWith(o))):P).map((e=>new t(e,"@","")));return new n(o,s+1,r,{canBeQuoted:!1})}),!1),q.select=async function(){if(this.isReplaceable&&null!==this.selectedItem.value){const e=this.selectedItem.value,t=this.textarea.value,n=this.effectiveParserResult.start-1,a=n+this.effectiveParserResult.name.length+1;this.textarea.value=`${t.slice(0,n)}@${e} ${t.slice(a)}`;const i=n+1+e.length+1;this.textarea.selectionStart=i,this.textarea.selectionEnd=i,this.textarea.dispatchEvent(new Event("input",{bubbles:!0})),this.hide()}},T.log("AutoComplete instance created."),$("#chat").on("click.atable",".atable-highlight",(function(){if(!E.enabled)return;const e=$(this).data("character-name");if(e){const t=document.getElementById("send_textarea"),n=t.value,a=t.selectionStart,i=t.selectionEnd,l="@"+e+" ",o=(a>0&&!/\s$/.test(n.substring(0,a))?" ":"")+l;t.value=n.substring(0,a)+o+n.substring(i);const s=a+o.length;t.selectionStart=s,t.selectionEnd=s,t.focus(),t.dispatchEvent(new Event("input",{bubbles:!0})),T.log(`Inserted "${e}" into textarea at position ${a}.`)}})),T.log("Click handler for highlighted names is active."),U=function(e){if(e.target.closest("#send_but")){const e=$("#send_textarea");let t=e.val();if(!E.enabled||!E.enableTemplateReplacement)return void T.log("[Input Replacement] Skipped: feature is disabled.");if(!t.includes("@"))return void T.log('[Input Replacement] Skipped: message contains no "@" symbol.');T.log("[Input Replacement] Intercepted a send action."),T.log("[Input Replacement] Original:",`'${t}'`);const n=E.templates[E.activeTemplateIndex];if(T.log("[Input Replacement] Template:",`'${n.content}'`),!n||!n.content||""===n.content.trim())return T.warn("[Input Replacement] Skipped: Active template is empty or invalid."),void toastr.warning("Atable: Active send template is empty.");if(!n.content.includes("{{name}}")&&!n.content.includes("{{content}}"))return T.error("[Input Replacement] Skipped: Active template is invalid (missing {{name}} or {{content}})."),void toastr.error("Atable: Active send template is invalid.");try{const a=t.split("@"),i=a.shift()+a.map((e=>{if(""===e.trim())return"";const t=e.match(/^\s*(\S+)/);if(!t)return e;const a=t[1],i=e.substring(t[0].length).trim();return n.content.replace("{{name}}",a).replace("{{content}}",i)})).join("");e.val(i),T.log("[Input Replacement] Transformed:",`'${i}'`)}catch(e){T.error("[Input Replacement] Error applying template:",e),toastr.error("Atable: Failed to apply send template.")}}},document.addEventListener("mouseup",U,!0),T.log("Send interceptor has been attached.")}()}function K(){T.log("Stopping services..."),J&&(J.disconnect(),J=null,T.log("MutationObserver stopped.")),q&&(q.hide(),q=null),$("#chat").off("click.atable"),U&&(document.removeEventListener("mouseup",U,!0),U=null),T.log("Input handlers stopped."),Q(A,"",0),T.log("Cleared extension prompt.")}globalThis.feinianyuAtableInterceptor=(e,t,n,a)=>{const i=function(){const e=E.promptTemplates[E.activePromptTemplateIndex];return E.enabled&&E.autoInject&&e&&""!==e.content.trim()?e.content:null}();if(i){const e=2;T.log("Auto-injecting prompt."),Q(A,i,e)}},jQuery((async()=>{try{await new Promise((e=>{const t=setInterval((()=>{$("#chat").length&&$("#extensions_settings").length&&$("#send_textarea").length&&(clearInterval(t),e())}),100)})),T.log("Core UI ready. Initializing extension..."),$("#extensions_settings").append('<style>.collapsible-help{margin-top:8px;margin-bottom:5px;width:100%}.collapsible-help summary{display:flex;align-items:center;padding:2px 0;cursor:pointer;outline:0;-webkit-tap-highlight-color:transparent}.collapsible-help summary::-webkit-details-marker{display:none}.collapsible-help summary{list-style:none}.summary-indicator{width:0;height:0;border-left:5px solid transparent;border-right:5px solid transparent;border-top:5px solid currentColor;margin-right:8px;opacity:.7;transform-origin:center;transition:transform .2s ease-in-out}.collapsible-help details[open]>summary .summary-indicator{transform:rotate(180deg)}.summary-title{color:var(--text-secondary-color,#b9b9b9);font-size:.9em;transition:color .2s ease}.collapsible-help summary:hover .summary-title{color:var(--link-color,#8ab4f8)}.details-content{padding-left:18px;padding-bottom:5px}.details-content p{font-size:.9em;color:var(--text-secondary-color,#b9b9b9);line-height:1.6;margin:5px 0 0 0}.details-content p b{color:var(--text-color,#e1e1e1)}.disabled-content{opacity:.6;pointer-events:none}#atable-log-textarea{font-size:.65em;line-height:1.4}</style> <div class="feinianyu-atable-settings"> <div class="inline-drawer"> <div class="inline-drawer-toggle inline-drawer-header"> <b>Atable 插件设置</b> <div class="inline-drawer-icon fa-solid fa-circle-chevron-down"></div> </div> <div class="inline-drawer-content"> <div class="setting_item"> <label for="feinianyu_atable_enabled" class="flex-container"> <input type="checkbox" id="feinianyu_atable_enabled"> <span>启用 Atable 插件</span> </label> </div> <hr> <div id="feinianyu_atable_main_settings_container"> <div class="form_group_boxtitle">输入增强</div> <div class="setting_item"> <label for="feinianyu_atable_enable_template_replacement" class="flex-container"> <input type="checkbox" id="feinianyu_atable_enable_template_replacement"> <span>启用输入增强</span> </label> <div class="collapsible-help"> <details> <summary> <div class="summary-indicator"></div> <span class="summary-title">这是什么？</span> </summary> <div class="details-content"> <p>启用后，在输入框中键入的 "@角色名 内容" 将在发送时被替换为下方选定的模板格式。其中 {{name}} 为名字，{{content}} 宏为内容</p> <p>例如：当启用了默认模板时</p> <p>在输入框输入：今天天气真好 @张三 要出去走走吗？ @李四 你呢？</p> <p>会被替换为：今天天气真好 （我对张三说）要出去走走吗？ （我对李四说）你呢？</p> </div> </details> </div> </div> <div class="form-group"> <label>发送模板管理 (点击选择激活的模板)</label> <div id="feinianyu_atable_template_list_container"> </div> <div id="feinianyu_atable_add_template" class="menu_button menu_button_icon"> <i class="fa-solid fa-plus"></i> <span>添加新模板</span> </div> </div> <hr> <div class="form_group_boxtitle">聊天显示与渲染</div> <div class="form-group"> <label for="feinianyu_atable_nonHighlightedWords">不高亮词汇</label> <p class="description">在这里输入不希望被高亮的词语，用英文逗号分隔。例如：你,我,他,她</p> <input type="text" id="feinianyu_atable_nonHighlightedWords" class="text_pole"> </div> <div class="form-group"> <label>高亮样式管理 (点击选择激活的样式)</label> <div id="feinianyu_atable_highlight_style_list_container"> </div> <div id="feinianyu_atable_add_highlight_style" class="menu_button menu_button_icon"> <i class="fa-solid fa-plus"></i> <span>添加新样式</span> </div> </div> <hr> <div class="form_group_boxtitle">AI 提示词</div> <div class="setting_item"> <label for="feinianyu_atable_auto_inject" class="flex-container"> <input type="checkbox" id="feinianyu_atable_auto_inject"> <span>自动注入提示词</span> </label> <div class="collapsible-help"> <details> <summary> <div class="summary-indicator"></div> <span class="summary-title">这是什么？如何使用？</span> </summary> <div class="details-content"> <p>启用后，每次发送消息都会自动在最终提示词中加入下方选定的指令，以引导AI返回特定格式。</p> <p><b>例如：</b>你可以创建一个提示词，要求AI在回复中用特定标签包裹角色名，这样插件才能识别并高亮它们。</p> <p>选择一个下方激活的模板，它将在生成回复时被自动添加到你的主输入内容的末尾。</p> </div> </details> </div> </div> <div class="form-group"> <label>提示词模板管理 (点击选择激活的模板)</label> <div id="feinianyu_atable_prompt_template_list_container"> </div> <div class="menu_button menu_button_icon" id="feinianyu_atable_add_prompt_template"> <i class="fa-solid fa-plus"></i> <span>添加新提示词</span> </div> </div> <hr> <div class="form_group_boxtitle">高级：自定义渲染规则</div> <div class="collapsible-help"> <details> <summary> <div class="summary-indicator"></div> <span class="summary-title">这是什么？</span> </summary> <div class="details-content"> <p>这里定义了插件如何从AI的回复中识别出需要高亮的内容。通常不需要修改。如果AI总是返回无法被解析的标签，可以在这里加入。</p> <p>例如：AI 总是返回 [at-tah name = "xxx"] ... [/at-tag]</p> <p>那么可以将 at-tah 加入到 开始标签匹配模式 中。 </p></div> </details> </div> <div class="form-group"> <label>开始标签匹配模式</label> <div id="feinianyu_atable_opening_tag_patterns_container" class="tag-container"> </div> <div class="add-tag-container"> <input type="text" id="feinianyu_atable_new_opening_tag_pattern" class="text_pole" placeholder="输入模式后按回车或点击添加"> <div id="feinianyu_atable_add_opening_tag_pattern" class="menu_button menu_button_icon"> <i class="fa-solid fa-plus"></i> <span>添加</span> </div> </div> </div> <div class="form-group"> <label>结束标签匹配模式</label> <div id="feinianyu_atable_closing_tag_patterns_container" class="tag-container"> </div> <div class="add-tag-container"> <input type="text" id="feinianyu_atable_new_closing_tag_pattern" class="text_pole" placeholder="输入模式后按回车或点击添加"> <div id="feinianyu_atable_add_closing_tag_pattern" class="menu_button menu_button_icon"> <i class="fa-solid fa-plus"></i> <span>添加</span> </div> </div> </div> </div> <hr> <div class="form_group_boxtitle">危险区域</div> <div class="setting_item"> <div id="feinianyu_atable_restore_defaults" class="menu_button menu_button_icon menu_button_danger"> <i class="fa-solid fa-arrows-rotate"></i> <span>恢复默认设置</span> </div> <p class="description">这将重置本插件的所有设置为初始状态，包括所有你添加的模板和样式。此操作无法撤销。</p> </div> <hr> <div class="form_group_boxtitle">插件日志</div> <div class="collapsible-help"> <details> <summary> <div class="summary-indicator"></div> <span class="summary-title">显示/隐藏日志</span> </summary> <div class="details-content"> <div class="atable-log-controls" style="margin-bottom:10px;display:flex;gap:10px"> <div id="atable-copy-log" class="menu_button menu_button_icon"> <i class="fa-solid fa-copy"></i> <span>复制日志</span> </div> </div> <textarea id="atable-log-textarea" readonly="readonly" rows="15" class="text_pole" style="width:100%;resize:vertical"></textarea> </div> </details> </div> </div> </div> </div> <div id="feinianyu_atable_preview_styles"></div> '),$("#feinianyu_atable_dynamic_styles").length||$("head").append('<style id="feinianyu_atable_dynamic_styles"></style>'),B(),E.enabled&&await G(),$("#feinianyu_atable_enabled").on("change",(async function(){this.checked?await G():K()})),T.log("Extension fully initialized and interceptor is globally available.")}catch(e){console.error("[Feinianyu-Atable] A fatal error occurred during extension initialization:",e),toastr.error("Feinianyu-Atable failed to load. Please check the browser console (F12) for more details.","Extension Error")}}))})();